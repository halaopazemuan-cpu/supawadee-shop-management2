<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบจัดการคลังสินค้า - ร้านสุภาวดี</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #d63384;
      --secondary: #9c27b0;
      --light-pink: #fce7f3;
      --light-purple: #f3e8fd;
      --gray: #6c757d;
      --light-gray: #f8f9fa;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
      --white: #FFFFFF;
      --text-dark: #212121;
      --border-color: #e0e0e0;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    }
    
    body { 
      background: linear-gradient(135deg, var(--light-pink), var(--light-purple)); 
      color: var(--text-dark); 
      line-height: 1.6; 
      min-height: 100vh; 
    }
    
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 20px; 
    }
    
    /* Header */
    .header { 
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 25px 30px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .header-icon {
      font-size: 40px;
      background: rgba(255,255,255,0.2);
      width: 70px;
      height: 70px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .header-title {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
    }
    
    .header-subtitle {
      margin: 5px 0 0 0;
      font-size: 16px;
      opacity: 0.9;
    }
    
    /* ปุ่มทั่วไป */
    button {
      cursor: pointer;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    .btn {
      padding: 12px 24px;
      font-size: 15px;
    }
    
    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
    }
    
    .btn-large {
      padding: 16px 32px;
      font-size: 16px;
    }
    
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary), var(--secondary)); 
      color: white; 
    }
    
    .btn-success { 
      background: linear-gradient(135deg, var(--success), #20c997); 
      color: white; 
    }
    
    .btn-warning { 
      background: linear-gradient(135deg, var(--warning), #fd9843); 
      color: white; 
    }
    
    .btn-danger { 
      background: linear-gradient(135deg, var(--danger), #e83e8c); 
      color: white; 
    }
    
    .btn-info { 
      background: linear-gradient(135deg, var(--info), #6f42c1); 
      color: white; 
    }
    
    .btn-secondary { 
      background: linear-gradient(135deg, var(--gray), #495057); 
      color: white; 
    }
    
    .btn-light {
      background: var(--light-gray);
      color: var(--gray);
      border: 2px solid var(--border-color);
    }
    
    .btn-light:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .back-btn {
      display: inline-flex;
      align-items: center;
      padding: 12px 24px;
      background: rgba(255,255,255,0.2);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.3);
      gap: 8px;
    }
    
    .back-btn:hover { 
      background: rgba(255,255,255,0.3); 
      transform: translateY(-2px); 
    }
    
    /* Statistics */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      text-align: center;
      border-left: 5px solid var(--primary);
      transition: transform 0.3s ease;
      cursor: pointer;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }
    
    .stat-icon {
      font-size: 32px;
      margin-bottom: 15px;
      color: var(--primary);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      margin: 10px 0;
    }
    
    .stat-label {
      color: var(--gray);
      font-size: 15px;
      font-weight: 500;
    }
    
    /* Controls */
    .controls-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 25px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }
    
    .search-box {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 300px;
    }
    
    .search-input {
      flex: 1;
      padding: 14px 20px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      font-size: 15px;
      background-color: var(--light-gray);
      transition: all 0.3s ease;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(214, 51, 132, 0.2);
      background-color: white;
    }
    
    .quick-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .quick-action-btn {
      background: var(--light-gray);
      color: var(--gray);
      border: 2px solid transparent;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .quick-action-btn:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(214, 51, 132, 0.2);
      border-color: var(--primary);
    }
    
    .filter-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    /* Products Grid */
    .products-grid-container {
      margin-bottom: 30px;
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      transition: all 0.3s ease;
    }
    
    .product-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      border: 2px solid transparent;
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }
    
    .product-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: var(--light-gray);
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    .product-card:hover .product-image {
      transform: scale(1.03);
    }
    
    .view-detail-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      z-index: 2;
    }
    
    .view-detail-btn:hover {
      background: var(--primary);
      transform: scale(1.1);
    }
    
    .product-content {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .product-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 5px;
      line-height: 1.4;
      cursor: pointer;
    }
    
    .product-title:hover {
      color: var(--primary);
    }
    
    .product-code {
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .product-price {
      color: var(--primary);
      font-weight: 700;
      font-size: 20px;
      margin-bottom: 15px;
    }
    
    .product-stock {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding: 15px;
      background: var(--light-gray);
      border-radius: 10px;
      border-left: 5px solid var(--primary);
    }
    
    .stock-info {
      flex: 1;
    }
    
    .stock-label {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 5px;
    }
    
    .stock-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .stock-status {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    
    .product-actions {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 10px;
      margin-top: auto;
      width: 100%;
    }
    
    .stock-input {
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .stock-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(214, 51, 132, 0.1);
    }
    
    .add-stock-btn {
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
      width: 100%;
      color: white;
      border: none;
    }
    
    /* Product Detail Modal */
    .product-detail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      z-index: 2004;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .product-detail-content {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 900px;
      margin: 30px auto;
      position: relative;
      animation: slideUp 0.4s ease;
    }
    
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .product-detail-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 25px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .product-detail-title {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .close-product-detail {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 5px;
      transition: transform 0.3s ease;
    }
    
    .close-product-detail:hover {
      transform: rotate(90deg);
    }
    
    .product-detail-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
    }
    
    .product-detail-image-container {
      padding: 30px;
      background: var(--light-gray);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .product-detail-image {
      width: 100%;
      height: 400px;
      object-fit: contain;
      border-radius: 10px;
      background: white;
      padding: 20px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    .product-detail-image:hover {
      transform: scale(1.02);
    }
    
    .product-detail-info {
      padding: 40px;
    }
    
    .product-detail-name {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 5px;
      line-height: 1.3;
    }
    
    .product-detail-code {
      color: var(--gray);
      font-size: 16px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .product-detail-price {
      font-size: 32px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 30px;
    }
    
    .product-detail-stock-container {
      background: var(--light-gray);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      border-left: 5px solid var(--primary);
    }
    
    .product-detail-stock-label {
      font-size: 16px;
      color: var(--gray);
      margin-bottom: 10px;
    }
    
    .product-detail-stock-value {
      font-size: 48px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 15px;
    }
    
    .product-detail-status {
      display: inline-block;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 700;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .product-detail-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .detail-stock-input {
      width: 100%;
      padding: 15px;
      border: 3px solid var(--border-color);
      border-radius: 10px;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
    }
    
    .detail-stock-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(214, 51, 132, 0.2);
    }
    
    .product-detail-footer {
      display: flex;
      justify-content: space-between;
      padding: 25px 30px;
      background: var(--light-gray);
      border-top: 1px solid var(--border-color);
    }
    
    .nav-button {
      padding: 12px 25px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
    }
    
    .nav-button.prev {
      background: linear-gradient(135deg, var(--gray), #495057);
      color: white;
    }
    
    .nav-button.next {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }
    
    .nav-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .nav-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Loading */
    .loading-container {
      text-align: center;
      padding: 50px 20px;
      color: var(--gray);
    }
    
    .loading-spinner {
      font-size: 48px;
      color: var(--primary);
      margin-bottom: 20px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray);
      grid-column: 1 / -1;
    }
    
    .empty-state i {
      font-size: 64px;
      color: #e0e0e0;
      margin-bottom: 20px;
    }
    
    /* Fullscreen Settings Modal */
    .fullscreen-settings-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 2002;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    }
    
    .fullscreen-settings-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .fullscreen-settings-title {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .fullscreen-settings-content {
      padding: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .notification-rules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .notification-rule-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      position: relative;
    }
    
    .rule-form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-dark);
      font-size: 14px;
    }
    
    .form-input-small {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .form-input-small:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(214, 51, 132, 0.1);
    }
    
    /* Custom Notification Toggle */
    .custom-notification-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      padding: 10px;
      background-color: var(--light-gray);
      border-radius: 8px;
    }
    
    .toggle-label {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 14px;
    }
    
    /* Custom Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--primary);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    /* Rule Button */
    .rule-btn {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    /* Rule Product Count Badge */
    .rule-product-count {
      display: inline-block;
      background-color: var(--primary);
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 5px;
      vertical-align: middle;
    }
    
    /* Product Selection Modal */
    .product-selection-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      z-index: 2003;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    
    .product-selection-content {
      background: white;
      padding: 25px;
      border-radius: 15px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      animation: slideUp 0.4s ease;
    }
    
    .product-selection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }
    
    .product-selection-title {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close-product-selection {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray);
      padding: 5px;
      transition: transform 0.3s ease;
    }
    
    .close-product-selection:hover {
      transform: rotate(90deg);
    }
    
    .product-selection-search {
      margin-bottom: 20px;
    }
    
    .selection-search-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
    }
    
    .product-selection-list {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
    }
    
    .selection-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .selection-item:hover {
      background-color: var(--light-gray);
    }
    
    .selection-item:last-child {
      border-bottom: none;
    }
    
    .selection-checkbox {
      margin-right: 15px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .selection-item-info {
      flex: 1;
    }
    
    .selection-item-name {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 5px;
    }
    
    .selection-item-details {
      display: flex;
      gap: 15px;
      color: var(--gray);
      font-size: 13px;
    }
    
    .selection-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }
    
    .selection-count {
      font-size: 14px;
      color: var(--primary);
      font-weight: 600;
    }
    
    /* Alert Messages */
    .custom-alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 10px;
      z-index: 9999;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      max-width: 400px;
      animation: slideInRight 0.3s ease;
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .container {
        max-width: 95%;
      }
      
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }
    
    @media (max-width: 992px) {
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      }
      
      .notification-rules-grid { 
        grid-template-columns: 1fr; 
      }
      
      .product-detail-body {
        grid-template-columns: 1fr;
      }
      
      .product-detail-image {
        height: 300px;
      }
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
        gap: 20px;
      }
      
      .controls-container {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-box {
        min-width: 100%;
      }
      
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }
      
      .product-stock {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .stock-status {
        align-self: flex-end;
      }
      
      .product-detail-name {
        font-size: 24px;
      }
      
      .product-detail-price {
        font-size: 28px;
      }
      
      .product-detail-stock-value {
        font-size: 40px;
      }
      
      .product-detail-footer {
        flex-direction: column;
        gap: 15px;
      }
      
      .nav-button {
        width: 100%;
        justify-content: center;
      }
      
      .product-detail-controls {
        grid-template-columns: 1fr;
      }
      
      .product-actions {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 576px) {
      .container {
        padding: 15px;
      }
      
      .products-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .product-image {
        height: 180px;
      }
      
      .product-detail-content {
        margin: 10px;
      }
      
      .product-detail-info {
        padding: 25px;
      }
      
      .product-detail-stock-value {
        font-size: 36px;
      }
    }
    
    @media (max-width: 400px) {
      .product-image {
        height: 160px;
      }
      
      .product-content {
        padding: 15px;
      }
      
      .stock-value {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <div class="header-icon">
          <i class="fas fa-warehouse"></i>
        </div>
        <div>
          <h1 class="header-title">ระบบจัดการคลังสินค้า</h1>
          <p class="header-subtitle">ร้านของใช้และเครื่องสำอางคุณสุภาวดี</p>
        </div>
      </div>
      <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <a href="admin.html" class="back-btn">
          <i class="fas fa-arrow-left"></i> กลับสู่หน้าหลัก
        </a>
        <button class="back-btn" onclick="openFullscreenSettings()" style="background: rgba(255,255,255,0.3);">
          <i class="fas fa-cog"></i> ตั้งค่าการแจ้งเตือน
        </button>
      </div>
    </div>

    <!-- Statistics -->
    <div class="stats-container">
      <div class="stat-card" onclick="filterByStatus('all')">
        <i class="fas fa-boxes stat-icon"></i>
        <div class="stat-value" id="totalProducts">0</div>
        <div class="stat-label">สินค้าทั้งหมด</div>
      </div>
      <div class="stat-card" onclick="filterByStatus('in_stock')">
        <i class="fas fa-check-circle stat-icon"></i>
        <div class="stat-value" id="inStockProducts">0</div>
        <div class="stat-label">พร้อมขาย</div>
      </div>
      <div class="stat-card" onclick="filterByStatus('low_stock')">
        <i class="fas fa-exclamation-triangle stat-icon"></i>
        <div class="stat-value" id="lowStockProducts">0</div>
        <div class="stat-label">ใกล้หมด</div>
      </div>
      <div class="stat-card" onclick="filterByStatus('out_of_stock')">
        <i class="fas fa-times-circle stat-icon"></i>
        <div class="stat-value" id="outOfStockProducts">0</div>
        <div class="stat-label">สินค้าหมด</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls-container">
      <div class="search-box">
        <input type="text" id="searchInput" class="search-input" placeholder="ค้นหาสินค้าด้วยชื่อหรือรหัส..." onkeyup="handleSearch(event)">
        <button class="btn-primary" onclick="searchProducts()">
          <i class="fas fa-search"></i> ค้นหา
        </button>
        <button class="btn-secondary" onclick="clearSearch()">
          <i class="fas fa-times"></i> ล้าง
        </button>
      </div>
      
      <div style="display: flex; gap: 10px; align-items: center;">
        <button onclick="refreshData()" class="btn-info btn-small">
          <i class="fas fa-sync-alt"></i> รีเฟรช
        </button>
        <div class="filter-buttons">
          <button onclick="filterByStatus('all')" class="quick-action-btn">
            ทั้งหมด
          </button>
          <button onclick="filterByStatus('in_stock')" class="quick-action-btn">
            พร้อมขาย
          </button>
          <button onclick="filterByStatus('low_stock')" class="quick-action-btn">
            ใกล้หมด
          </button>
          <button onclick="filterByStatus('out_of_stock')" class="quick-action-btn">
            สินค้าหมด
          </button>
        </div>
      </div>
      
      <div class="quick-actions">
        <button class="quick-action-btn" onclick="exportToExcel()">
          <i class="fas fa-file-excel"></i> ส่งออก Excel
        </button>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="products-grid-container">
      <div class="products-grid" id="productsGrid">
        <!-- สินค้าจะถูกแสดงที่นี่ -->
      </div>
      <div class="loading-container" id="loading">
        <i class="fas fa-spinner loading-spinner"></i>
        <div style="font-size: 18px; font-weight: 500;">กำลังโหลดข้อมูลสินค้า...</div>
      </div>
    </div>
  </div>

  <!-- Fullscreen Settings Modal -->
  <div class="fullscreen-settings-modal" id="fullscreenSettingsModal">
    <div class="fullscreen-settings-header">
      <div class="fullscreen-settings-title">
        <i class="fas fa-bell"></i> การตั้งค่าการแจ้งเตือนสินค้า
      </div>
      <button class="close-settings-panel" onclick="closeFullscreenSettings()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="fullscreen-settings-content">
      <h3><i class="fas fa-sliders-h"></i> ตั้งค่าสถานะสินค้าตามจำนวนคงเหลือ</h3>
      <p style="color: var(--gray); margin-bottom: 20px;">
        กำหนดเงื่อนไขการแจ้งเตือนสถานะสินค้าตามจำนวนคงเหลือ และเลือกว่าต้องการแจ้งเตือนสำหรับสินค้าใดบ้าง
      </p>
      
      <div style="display:flex; gap:10px; margin-bottom:30px; flex-wrap: wrap;">
        <button class="btn-success" onclick="addNewNotificationRule()">
          <i class="fas fa-plus"></i> เพิ่มกฎใหม่
        </button>
        <button class="btn-secondary" onclick="resetToDefaultRules()">
          <i class="fas fa-undo"></i> คืนค่าเริ่มต้น
        </button>
        <button class="btn-primary" onclick="saveNotificationSettings()">
          <i class="fas fa-save"></i> บันทึกการตั้งค่า
        </button>
      </div>
      
      <div class="notification-rules-grid" id="notificationRulesContainer">
        <!-- กฎการแจ้งเตือนจะแสดงที่นี่ -->
      </div>
      
      <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color);">
        <h4><i class="fas fa-info-circle"></i> คำแนะนำการใช้งาน</h4>
        <ul style="color: var(--gray); margin-left: 20px;">
          <li>เลือก "แจ้งเตือน" หากต้องการให้แสดงสถานะนี้ในตารางสินค้า</li>
          <li>เลือก "เลือกสินค้า" เพื่อกำหนดรายการสินค้าที่ต้องการแจ้งเตือนเฉพาะ</li>
          <li>เลือกเงื่อนไขตามต้องการ (มากกว่า, น้อยกว่า, ระหว่าง)</li>
          <li>ตั้งค่าชื่อสถานะและสีให้แตกต่างกันเพื่อให้เห็นชัดเจน</li>
          <li>ระบบจะเลือกสถานะที่ตรงกับเงื่อนไขแรกที่เจอ</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Product Detail Modal -->
  <div class="product-detail-modal" id="productDetailModal">
    <div class="product-detail-content">
      <div class="product-detail-header">
        <div class="product-detail-title">
          <i class="fas fa-box-open"></i> รายละเอียดสินค้า
        </div>
        <button class="close-product-detail" onclick="closeProductDetail()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="product-detail-body">
        <div class="product-detail-image-container">
          <img id="productDetailImage" class="product-detail-image" alt="สินค้า" onclick="zoomProductImage()">
        </div>
        
        <div class="product-detail-info">
          <h2 id="productDetailName" class="product-detail-name"></h2>
          <div id="productDetailCode" class="product-detail-code">
            <i class="fas fa-barcode"></i> <span id="productDetailCodeText"></span>
          </div>
          <div id="productDetailPrice" class="product-detail-price"></div>
          
          <div class="product-detail-stock-container">
            <div class="product-detail-stock-label">จำนวนคงเหลือ</div>
            <div id="productDetailStock" class="product-detail-stock-value"></div>
            <div id="productDetailStatus" class="product-detail-status"></div>
          </div>
          
          <div class="product-detail-controls">
            <input type="number" id="detailStockInput" class="detail-stock-input" 
                   min="1" value="1" placeholder="จำนวนเพิ่ม">
            <button class="add-stock-btn" onclick="addStockFromDetail()" style="font-size: 18px; padding: 15px;">
              <i class="fas fa-plus"></i> เพิ่มสต็อก
            </button>
          </div>
          
          <div style="margin-top: 20px; color: var(--gray); font-size: 14px; text-align: center;">
            <i class="fas fa-info-circle"></i> ใช้ปุ่มลูกศรซ้าย/ขวา หรือปุ่ม Next/Previous เพื่อเลื่อนดูสินค้า
          </div>
        </div>
      </div>
      
      <div class="product-detail-footer">
        <button class="nav-button prev" onclick="showPreviousProduct()" id="prevButton">
          <i class="fas fa-chevron-left"></i> สินค้าก่อนหน้า
        </button>
        <div style="display: flex; gap: 10px;">
          <button class="nav-button" onclick="closeProductDetail()" style="background: var(--gray); color: white;">
            <i class="fas fa-times"></i> ปิด
          </button>
        </div>
        <button class="nav-button next" onclick="showNextProduct()" id="nextButton">
          สินค้าถัดไป <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Product Selection Modal -->
  <div class="product-selection-modal" id="productSelectionModal">
    <div class="product-selection-content">
      <div class="product-selection-header">
        <div class="product-selection-title">
          <i class="fas fa-boxes"></i> เลือกสินค้าที่ต้องการแจ้งเตือน
        </div>
        <button class="close-product-selection" onclick="closeProductSelectionModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="product-selection-search">
        <input type="text" id="productSelectionSearch" class="selection-search-input" placeholder="ค้นหาสินค้า...">
      </div>
      
      <div class="product-selection-list" id="productSelectionList">
        <!-- รายการสินค้าจะแสดงที่นี่ -->
      </div>
      
      <div class="selection-actions">
        <div class="selection-count">
          เลือกแล้ว: <span id="selectedProductsCount">0</span> รายการ
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn-light btn-small" onclick="selectAllProducts()">
            <i class="fas fa-check-square"></i> เลือกทั้งหมด
          </button>
          <button class="btn-light btn-small" onclick="deselectAllProducts()">
            <i class="fas fa-times-circle"></i> ยกเลิกทั้งหมด
          </button>
          <button class="btn-success btn-small" onclick="saveProductSelection()">
            <i class="fas fa-save"></i> บันทึก
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const SUPABASE_URL = "https://rhcevdopguxtzupuxipk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoY2V2ZG9wZ3V4dHp1cHV4aXBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MjEyNDUsImV4cCI6MjA3MzM5NzI0NX0.Ot6aYOsIRgKjMWrbjPTEXuaWOqXYxYHiXKN1c7AhPyQ";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // State Management
    let products = [];
    let filteredProducts = [];
    let notificationRules = [];
    let nextRuleId = 1;
    let currentRuleForProductSelection = null;
    let productSelectionCache = {};
    let currentProductIndex = 0;
    let currentFilteredProducts = [];
    let searchDebounceTimer = null;

    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const productsGrid = document.getElementById('productsGrid');
    const loading = document.getElementById('loading');
    const totalProductsElement = document.getElementById('totalProducts');
    const inStockProductsElement = document.getElementById('inStockProducts');
    const lowStockProductsElement = document.getElementById('lowStockProducts');
    const outOfStockProductsElement = document.getElementById('outOfStockProducts');
    const fullscreenSettingsModal = document.getElementById('fullscreenSettingsModal');
    const notificationRulesContainer = document.getElementById('notificationRulesContainer');
    const productSelectionModal = document.getElementById('productSelectionModal');
    const productSelectionList = document.getElementById('productSelectionList');
    const productSelectionSearch = document.getElementById('productSelectionSearch');
    const selectedProductsCount = document.getElementById('selectedProductsCount');
    const productDetailModal = document.getElementById('productDetailModal');
    const productDetailImage = document.getElementById('productDetailImage');
    const productDetailName = document.getElementById('productDetailName');
    const productDetailCodeText = document.getElementById('productDetailCodeText');
    const productDetailPrice = document.getElementById('productDetailPrice');
    const productDetailStock = document.getElementById('productDetailStock');
    const productDetailStatus = document.getElementById('productDetailStatus');
    const detailStockInput = document.getElementById('detailStockInput');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');

    // ========== INITIALIZATION ==========

    // Initialize application
    document.addEventListener("DOMContentLoaded", async function() {
      await initializeApp();
      
      // Event Listeners
      productSelectionSearch.addEventListener('input', filterProductSelection);
      
      // Keyboard shortcuts for product detail modal
      document.addEventListener('keydown', function(event) {
        if (productDetailModal.style.display === 'block') {
          if (event.key === 'ArrowLeft') showPreviousProduct();
          if (event.key === 'ArrowRight') showNextProduct();
          if (event.key === 'Escape') closeProductDetail();
          if (event.key === '+' || event.key === '=') {
            event.preventDefault();
            const currentVal = parseInt(detailStockInput.value) || 1;
            detailStockInput.value = currentVal + 1;
          }
          if (event.key === '-') {
            event.preventDefault();
            const currentVal = parseInt(detailStockInput.value) || 1;
            if (currentVal > 1) detailStockInput.value = currentVal - 1;
          }
        }
        
        if (event.key === 'Escape') {
          closeFullscreenSettings();
          closeProductSelectionModal();
        }
      });
    });

    // Main initialization
    async function initializeApp() {
      try {
        showLoading(true);
        await Promise.all([
          loadProducts(),
          loadNotificationRules()
        ]);
        showLoading(false);
        updateStatistics();
        renderProductsGrid();
      } catch (error) {
        console.error("เกิดข้อผิดพลาดในการเริ่มต้นแอปพลิเคชัน:", error);
        showError("ไม่สามารถโหลดข้อมูลได้ กรุณารีเฟรชหน้าเว็บ");
      }
    }

    // ========== PRODUCT FUNCTIONS ==========

    // Load products from Supabase
    async function loadProducts() {
      try {
        const { data, error } = await client.from("products")
          .select("id, product_code, name, price, stock, image_url, description, created_at, product_number")
          .order('created_at', { ascending: false });

        if (error) throw error;
        
        if (!data || data.length === 0) {
          renderEmptyState();
          return;
        }

        products = data;
        filteredProducts = [...products];
      } catch (err) {
        console.error("โหลดข้อมูลสินค้าล้มเหลว:", err);
        throw err;
      }
    }

    // Update statistics
    function updateStatistics() {
      const totalProducts = products.length;
      const inStockProducts = products.filter(p => p.stock > 10).length;
      const lowStockProducts = products.filter(p => p.stock > 0 && p.stock <= 10).length;
      const outOfStockProducts = products.filter(p => p.stock === 0).length;
      
      totalProductsElement.textContent = totalProducts;
      inStockProductsElement.textContent = inStockProducts;
      lowStockProductsElement.textContent = lowStockProducts;
      outOfStockProductsElement.textContent = outOfStockProducts;
    }

    // Render products in grid view
    function renderProductsGrid() {
      productsGrid.innerHTML = '';

      if (filteredProducts.length === 0) {
        renderEmptyState();
        return;
      }

      filteredProducts.forEach(product => {
        const productStatus = getProductStatus(product);
        const imgSrc = product.image_url || 'https://via.placeholder.com/300x300/e3f2fd/1976d2?text=No+Image';
        const formattedPrice = parseFloat(product.price).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        const productCode = product.product_code || `P${String(product.product_number || product.id).padStart(4, '0')}`;
        
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.innerHTML = `
          <button class="view-detail-btn" onclick="openProductDetail(${product.id})" 
                  title="ดูรายละเอียด">
            <i class="fas fa-eye"></i>
          </button>
          <img src="${imgSrc}" class="product-image" 
               alt="${product.name}" onclick="openProductDetail(${product.id})">
          
          <div class="product-content">
            <div class="product-title" onclick="openProductDetail(${product.id})">
              ${product.name}
            </div>
            
            <div class="product-code">
              <i class="fas fa-barcode"></i> ${productCode}
            </div>
            <div class="product-price">฿${formattedPrice}</div>
            
            <div class="product-stock" style="border-left-color: ${productStatus.color};">
              <div class="stock-info">
                <div class="stock-label">จำนวนคงเหลือ</div>
                <div class="stock-value">${product.stock.toLocaleString()}</div>
              </div>
              <div class="stock-status" 
                   style="background-color: ${productStatus.color}20; 
                          color: ${productStatus.color}; 
                          border: 2px solid ${productStatus.color};">
                ${productStatus.message}
              </div>
            </div>
            
            <div class="product-actions">
              <input type="number" class="stock-input" id="qty-${product.id}" 
                     min="1" value="1" placeholder="จำนวน">
              <button class="add-stock-btn" onclick="updateStock(${product.id})" 
                      style="background: ${productStatus.color};">
                <i class="fas fa-plus"></i> เพิ่มสต็อก
              </button>
            </div>
          </div>
        `;
        
        productsGrid.appendChild(productCard);
      });
    }

    // Render empty state
    function renderEmptyState() {
      productsGrid.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-search"></i>
          <h3>ไม่พบสินค้า</h3>
          <p>ลองใช้คำค้นหาอื่นหรือล้างการค้นหา</p>
          <button onclick="clearSearch()" class="btn-primary" style="margin-top: 20px;">
            <i class="fas fa-times"></i> ล้างการค้นหา
          </button>
        </div>
      `;
    }

    // Get product status based on rules
    function getProductStatus(product) {
      if (!notificationRules || notificationRules.length === 0) {
        return {
          message: "ไม่ระบุ",
          color: "#6c757d"
        };
      }
      
      // Filter active rules
      const activeRules = notificationRules.filter(r => r.notify);
      
      if (activeRules.length === 0) {
        return {
          message: "ไม่ระบุ",
          color: "#6c757d"
        };
      }
      
      // Sort rules by specificity (rules with both min and max first)
      const sortedRules = [...activeRules].sort((a, b) => {
        const aSpecific = (a.min !== null && a.max !== null) ? 1 : 0;
        const bSpecific = (b.min !== null && b.max !== null) ? 1 : 0;
        return bSpecific - aSpecific; // More specific rules first
      });
      
      for (const rule of sortedRules) {
        // Check if rule applies to this product
        if (rule.customProducts && rule.selectedProductIds && rule.selectedProductIds.length > 0) {
          if (!rule.selectedProductIds.includes(product.id)) {
            continue;
          }
        }
        
        const matches = checkRuleMatch(rule, product.stock);
        
        if (matches) {
          return {
            message: rule.message,
            color: rule.color
          };
        }
      }
      
      // Default status
      return {
        message: "ปกติ",
        color: "#28a745"
      };
    }

    // Check if stock matches rule condition
    function checkRuleMatch(rule, stock) {
      const min = rule.min;
      const max = rule.max;
      
      // Convert stock to number
      const stockNum = parseFloat(stock);
      if (isNaN(stockNum)) return false;
      
      switch (rule.operator) {
        case '<':
          return max !== null && stockNum < parseFloat(max);
        case '>':
          return min !== null && stockNum > parseFloat(min);
        case '>= <=':
          return min !== null && max !== null && 
                 stockNum >= parseFloat(min) && stockNum <= parseFloat(max);
        case '>=':
          return min !== null && stockNum >= parseFloat(min);
        case '<=':
          return max !== null && stockNum <= parseFloat(max);
        default:
          return false;
      }
    }

    // Update stock to product
    async function updateStock(productId, quantity) {
      let qty;
      
      if (quantity === undefined) {
        const qtyInput = document.getElementById(`qty-${productId}`);
        qty = parseInt(qtyInput.value);
        
        if (isNaN(qty) || qty <= 0) {
          showAlert('กรุณาใส่จำนวนที่ถูกต้อง', 'warning');
          qtyInput.focus();
          return;
        }
      } else {
        qty = quantity;
      }
      
      const product = products.find(p => p.id === productId);
      if (!product) {
        showAlert('ไม่พบสินค้านี้', 'error');
        return;
      }
      
      const newStock = product.stock + qty;
      
      try {
        const { error } = await client.from("products")
          .update({ stock: newStock })
          .eq("id", productId);
        
        if (error) throw error;
        
        // Update local state
        product.stock = newStock;
        updateStatistics();
        renderProductsGrid();
        
        showAlert(`เพิ่มสต็อกสำเร็จ: ${product.name} +${qty} (รวม ${newStock})`, 'success');
        
        // Reset input
        if (quantity === undefined) {
          const qtyInput = document.getElementById(`qty-${productId}`);
          if (qtyInput) qtyInput.value = '1';
        } else {
          detailStockInput.value = '1';
        }
      } catch (err) {
        console.error('เพิ่มสต็อกล้มเหลว:', err);
        showAlert('ไม่สามารถเพิ่มสต็อกได้', 'error');
      }
    }

    // ========== PRODUCT DETAIL MODAL FUNCTIONS ==========

    // Open product detail modal
    function openProductDetail(productId) {
      // Find index of product in filteredProducts
      const index = filteredProducts.findIndex(p => p.id === productId);
      if (index === -1) return;
      
      currentProductIndex = index;
      currentFilteredProducts = [...filteredProducts];
      
      updateProductDetail();
      productDetailModal.style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Focus on input
      setTimeout(() => {
        detailStockInput.focus();
        detailStockInput.select();
      }, 300);
    }

    // Close product detail modal
    function closeProductDetail() {
      productDetailModal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Update product detail modal
    function updateProductDetail() {
      const product = currentFilteredProducts[currentProductIndex];
      if (!product) return;
      
      const productStatus = getProductStatus(product);
      const imgSrc = product.image_url || 'https://via.placeholder.com/500x500/e3f2fd/1976d2?text=No+Image';
      const formattedPrice = parseFloat(product.price).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      const productCode = product.product_code || `P${String(product.product_number || product.id).padStart(4, '0')}`;
      
      // Update details
      productDetailImage.src = imgSrc;
      productDetailImage.alt = product.name;
      productDetailName.textContent = product.name;
      productDetailCodeText.textContent = productCode;
      productDetailPrice.textContent = `฿${formattedPrice}`;
      productDetailStock.textContent = product.stock.toLocaleString();
      
      // Update status
      productDetailStatus.textContent = productStatus.message;
      productDetailStatus.style.backgroundColor = `${productStatus.color}20`;
      productDetailStatus.style.color = productStatus.color;
      productDetailStatus.style.border = `2px solid ${productStatus.color}`;
      
      // Update add stock button
      const addStockBtn = document.querySelector('.product-detail-controls .add-stock-btn');
      if (addStockBtn) {
        addStockBtn.style.backgroundColor = productStatus.color;
      }
      
      // Update nav buttons
      updateNavButtons();
    }

    // Update navigation buttons
    function updateNavButtons() {
      prevButton.disabled = currentProductIndex <= 0;
      nextButton.disabled = currentProductIndex >= currentFilteredProducts.length - 1;
      
      prevButton.style.opacity = prevButton.disabled ? '0.5' : '1';
      nextButton.style.opacity = nextButton.disabled ? '0.5' : '1';
    }

    // Show previous product
    function showPreviousProduct() {
      if (currentProductIndex > 0) {
        currentProductIndex--;
        updateProductDetail();
      }
    }

    // Show next product
    function showNextProduct() {
      if (currentProductIndex < currentFilteredProducts.length - 1) {
        currentProductIndex++;
        updateProductDetail();
      }
    }

    // Add stock from detail modal
    async function addStockFromDetail() {
      const product = currentFilteredProducts[currentProductIndex];
      if (!product) return;
      
      const qty = parseInt(detailStockInput.value);
      
      if (isNaN(qty) || qty <= 0) {
        showAlert('กรุณาใส่จำนวนที่ถูกต้อง', 'warning');
        detailStockInput.focus();
        return;
      }
      
      await updateStock(product.id, qty);
      updateProductDetail();
    }

    // Zoom product image
    function zoomProductImage() {
      const img = productDetailImage;
      if (img.style.transform === 'scale(1.5)') {
        img.style.transform = 'scale(1)';
        img.style.cursor = 'zoom-in';
      } else {
        img.style.transform = 'scale(1.5)';
        img.style.cursor = 'zoom-out';
      }
    }

    // ========== QUICK ACTION FUNCTIONS ==========

    // Export to Excel
    async function exportToExcel() {
      try {
        showAlert('กำลังเตรียมข้อมูลสำหรับส่งออก...', 'info');
        
        // สร้างข้อมูล CSV
        const headers = ['รหัสสินค้า', 'ชื่อสินค้า', 'ราคา', 'จำนวนคงเหลือ', 'สถานะ'];
        const data = filteredProducts.map(product => {
          const status = getProductStatus(product);
          const productCode = product.product_code || `P${String(product.product_number || product.id).padStart(4, '0')}`;
          return [
            productCode,
            product.name,
            parseFloat(product.price).toFixed(2),
            product.stock,
            status.message
          ];
        });
        
        // สร้าง CSV
        const csvContent = [
          headers.join(','),
          ...data.map(row => row.join(','))
        ].join('\n');
        
        // สร้าง Blob และดาวน์โหลด
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `สินค้า_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('ส่งออกข้อมูลสำเร็จ!', 'success');
      } catch (error) {
        console.error('Error exporting to Excel:', error);
        showAlert('ไม่สามารถส่งออกข้อมูลได้', 'error');
      }
    }

    // Refresh data
    async function refreshData() {
      try {
        showLoading(true);
        await loadProducts();
        updateStatistics();
        renderProductsGrid();
        showAlert('รีเฟรชข้อมูลสำเร็จ', 'success');
      } catch (error) {
        console.error('Error refreshing data:', error);
        showAlert('ไม่สามารถรีเฟรชข้อมูลได้', 'error');
      } finally {
        showLoading(false);
      }
    }

    // Filter by status
    function filterByStatus(statusType) {
      switch(statusType) {
        case 'all':
          filteredProducts = [...products];
          showAlert(`แสดงสินค้าทั้งหมด (${filteredProducts.length} รายการ)`, 'info');
          break;
        case 'in_stock':
          filteredProducts = products.filter(p => p.stock > 10);
          showAlert(`แสดงสินค้าพร้อมขาย (${filteredProducts.length} รายการ)`, 'success');
          break;
        case 'low_stock':
          filteredProducts = products.filter(p => p.stock > 0 && p.stock <= 10);
          showAlert(`แสดงสินค้าใกล้หมด (${filteredProducts.length} รายการ)`, 'warning');
          break;
        case 'out_of_stock':
          filteredProducts = products.filter(p => p.stock === 0);
          showAlert(`แสดงสินค้าหมด (${filteredProducts.length} รายการ)`, 'error');
          break;
      }
      
      renderProductsGrid();
      searchInput.value = '';
    }

    // ========== SEARCH FUNCTIONS ==========

    // Handle search with debounce
    function handleSearch(event) {
      if (event.key === 'Enter') {
        searchProducts();
        return;
      }
      
      clearTimeout(searchDebounceTimer);
      searchDebounceTimer = setTimeout(() => {
        searchProducts();
      }, 300);
    }

    // Search products
    function searchProducts() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredProducts = [...products];
      } else {
        filteredProducts = products.filter(product => 
          product.name.toLowerCase().includes(searchTerm) || 
          (product.product_code && product.product_code.toLowerCase().includes(searchTerm)) ||
          (product.product_number && product.product_number.toString().includes(searchTerm)) ||
          (product.description && product.description.toLowerCase().includes(searchTerm))
        );
      }
      
      renderProductsGrid();
    }

    // Clear search
    function clearSearch() {
      searchInput.value = '';
      filteredProducts = [...products];
      renderProductsGrid();
      searchInput.focus();
    }

    // ========== NOTIFICATION RULES SYSTEM ==========

    // Get random color for new rules
    function getRandomColor() {
      const colors = [
        '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2',
        '#EF476F', '#1B9AAA', '#FF9A76', '#7D5BA6', '#90BE6D',
        '#F8961E', '#43AA8B', '#577590', '#F94144', '#F3722C'
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // Save notification rules to localStorage
    function saveRulesToLocalStorage() {
      localStorage.setItem('stockNotificationRules', JSON.stringify(notificationRules));
    }

    // Load notification rules from localStorage
    function loadNotificationRules() {
      const savedRules = localStorage.getItem('stockNotificationRules');
      if (savedRules) {
        notificationRules = JSON.parse(savedRules);
        nextRuleId = notificationRules.length > 0 ? Math.max(...notificationRules.map(r => r.id)) + 1 : 1;
      } else {
        // Default rules
        notificationRules = [
          { 
            id: 1, 
            min: null, 
            max: 10, 
            operator: '<', 
            message: "น้อย", 
            color: "#dc3545", 
            notify: true,
            customProducts: false,
            selectedProductIds: []
          },
          { 
            id: 2, 
            min: 10, 
            max: 80, 
            operator: '>= <=', 
            message: "ปกติ", 
            color: "#28a745", 
            notify: true,
            customProducts: false,
            selectedProductIds: []
          },
          { 
            id: 3, 
            min: 80, 
            max: null, 
            operator: '>', 
            message: "มาก", 
            color: "#ffc107", 
            notify: false,
            customProducts: false,
            selectedProductIds: []
          }
        ];
        nextRuleId = 4;
        saveRulesToLocalStorage();
      }
    }

    // Validate a rule
    function validateRule(rule) {
      const errors = [];
      
      if (rule.notify) {
        // Check operator conditions
        switch (rule.operator) {
          case '<':
            if (rule.max === null || rule.max === '' || isNaN(parseFloat(rule.max))) {
              errors.push('กรุณาระบุค่าสูงสุดสำหรับเงื่อนไข "น้อยกว่า"');
            }
            break;
          case '>':
            if (rule.min === null || rule.min === '' || isNaN(parseFloat(rule.min))) {
              errors.push('กรุณาระบุค่าต่ำสุดสำหรับเงื่อนไข "มากกว่า"');
            }
            break;
          case '>= <=':
            if (rule.min === null || rule.min === '' || isNaN(parseFloat(rule.min)) || 
                rule.max === null || rule.max === '' || isNaN(parseFloat(rule.max))) {
              errors.push('กรุณาระบุทั้งค่าต่ำสุดและค่าสูงสุดสำหรับเงื่อนไข "ระหว่าง"');
            } else if (parseFloat(rule.min) >= parseFloat(rule.max)) {
              errors.push('ค่าต่ำสุดต้องน้อยกว่าค่าสูงสุด');
            }
            break;
          case '>=':
            if (rule.min === null || rule.min === '' || isNaN(parseFloat(rule.min))) {
              errors.push('กรุณาระบุค่าต่ำสุดสำหรับเงื่อนไข "มากกว่าหรือเท่ากับ"');
            }
            break;
          case '<=':
            if (rule.max === null || rule.max === '' || isNaN(parseFloat(rule.max))) {
              errors.push('กรุณาระบุค่าสูงสุดสำหรับเงื่อนไข "น้อยกว่าหรือเท่ากับ"');
            }
            break;
        }
        
        // Check message
        if (!rule.message || rule.message.trim() === '') {
          errors.push('กรุณาระบุข้อความแจ้งเตือน');
        }
      }
      
      return errors;
    }

    // Add new notification rule
    function addNewNotificationRule() {
      // Find highest max value from existing rules
      const existingMaxValues = notificationRules
        .filter(rule => rule.max !== null)
        .map(rule => parseFloat(rule.max));
      
      const highestMax = existingMaxValues.length > 0 
        ? Math.max(...existingMaxValues) 
        : 0;
      
      const newRule = {
        id: nextRuleId++,
        min: highestMax, // Start from highest max
        max: highestMax + 10, // Add 10 to highest max
        operator: '>= <=',
        message: "กำหนดเอง",
        color: getRandomColor(),
        notify: true,
        customProducts: false,
        selectedProductIds: []
      };
      
      notificationRules.push(newRule);
      saveRulesToLocalStorage();
      renderNotificationRules();
      
      // Scroll to new rule
      setTimeout(() => {
        const rules = notificationRulesContainer.querySelectorAll('.notification-rule-card');
        if (rules.length > 0) {
          rules[rules.length - 1].scrollIntoView({ behavior: 'smooth' });
        }
      }, 100);
    }

    // Update rule functions
    function updateRuleOperator(ruleId, operator) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (rule) {
        rule.operator = operator;
        saveRulesToLocalStorage();
        renderNotificationRules(); // Re-render to update UI
      }
    }
    
    function updateRuleMin(ruleId, min) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (rule) {
        rule.min = min === '' ? null : parseFloat(min);
        saveRulesToLocalStorage();
      }
    }
    
    function updateRuleMax(ruleId, max) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (rule) {
        rule.max = max === '' ? null : parseFloat(max);
        saveRulesToLocalStorage();
      }
    }
    
    function updateRuleMessage(ruleId, message) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (rule) {
        rule.message = message;
        saveRulesToLocalStorage();
      }
    }
    
    function updateRuleColor(ruleId, color) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (rule) {
        rule.color = color;
        saveRulesToLocalStorage();
      }
    }
    
    function toggleNotificationRule(ruleId, notify) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (rule) {
        rule.notify = notify;
        saveRulesToLocalStorage();
        renderNotificationRules(); // Re-render to show/hide errors
      }
    }

    // Change product selection type
    function changeProductSelectionType(ruleId, type) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (!rule) return;
      
      if (type === 'all') {
        rule.customProducts = false;
        rule.selectedProductIds = [];
      } else if (type === 'custom') {
        rule.customProducts = true;
        if (!rule.selectedProductIds) {
          rule.selectedProductIds = [];
        }
      }
      
      saveRulesToLocalStorage();
      renderNotificationRules();
    }

    // Open product selection modal for a specific rule
    function openProductSelectionForRule(ruleId) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (!rule) return;
      
      currentRuleForProductSelection = ruleId;
      
      productSelectionCache = {
        ruleId: ruleId,
        selectedIds: [...(rule.selectedProductIds || [])]
      };
      
      renderProductSelectionList();
      productSelectionModal.style.display = "flex";
      
      updateSelectedProductsCount();
    }

    // Render product selection list
    function renderProductSelectionList(filter = '') {
      productSelectionList.innerHTML = "";
      
      if (products.length === 0) {
        productSelectionList.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--gray);">
            <i class="fas fa-box-open" style="font-size: 40px; margin-bottom: 15px;"></i>
            <p>ไม่พบข้อมูลสินค้า</p>
          </div>
        `;
        return;
      }
      
      const searchTerm = filter.toLowerCase().trim();
      let filteredProductsList = products;
      
      if (searchTerm) {
        filteredProductsList = products.filter(p =>
          p.name.toLowerCase().includes(searchTerm) ||
          (p.product_code && p.product_code.toLowerCase().includes(searchTerm)) ||
          (p.product_number && p.product_number.toString().includes(searchTerm))
        );
      }
      
      filteredProductsList.forEach(product => {
        const isSelected = productSelectionCache.selectedIds.includes(product.id);
        const productCode = product.product_code || `P${String(product.product_number || product.id).padStart(4, '0')}`;
        
        const selectionItem = document.createElement('div');
        selectionItem.className = 'selection-item';
        selectionItem.innerHTML = `
          <input type="checkbox" class="selection-checkbox" 
                 id="product-${product.id}" 
                 ${isSelected ? 'checked' : ''}
                 onchange="toggleProductSelection(${product.id}, this.checked)">
          <div class="selection-item-info">
            <div class="selection-item-name">${product.name}</div>
            <div class="selection-item-details">
              <span>รหัส: ${productCode}</span>
              <span>ราคา: ${Number(product.price).toFixed(2)} บาท</span>
              <span>คงเหลือ: ${product.stock} ชิ้น</span>
            </div>
          </div>
        `;
        productSelectionList.appendChild(selectionItem);
      });
    }

    // Filter product selection list
    function filterProductSelection() {
      const searchTerm = productSelectionSearch.value;
      renderProductSelectionList(searchTerm);
    }

    // Toggle product selection
    function toggleProductSelection(productId, isSelected) {
      if (isSelected) {
        if (!productSelectionCache.selectedIds.includes(productId)) {
          productSelectionCache.selectedIds.push(productId);
        }
      } else {
        const index = productSelectionCache.selectedIds.indexOf(productId);
        if (index > -1) {
          productSelectionCache.selectedIds.splice(index, 1);
        }
      }
      
      updateSelectedProductsCount();
    }

    // Update selected products count
    function updateSelectedProductsCount() {
      selectedProductsCount.textContent = productSelectionCache.selectedIds.length;
    }

    // Select all products
    function selectAllProducts() {
      const checkboxes = productSelectionList.querySelectorAll('.selection-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = true;
        const productId = parseInt(cb.id.replace('product-', ''));
        if (!productSelectionCache.selectedIds.includes(productId)) {
          productSelectionCache.selectedIds.push(productId);
        }
      });
      
      updateSelectedProductsCount();
    }

    // Deselect all products
    function deselectAllProducts() {
      const checkboxes = productSelectionList.querySelectorAll('.selection-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = false;
      });
      
      productSelectionCache.selectedIds = [];
      updateSelectedProductsCount();
    }

    // Save product selection
    function saveProductSelection() {
      if (!currentRuleForProductSelection) return;
      
      const rule = notificationRules.find(r => r.id === currentRuleForProductSelection);
      if (!rule) return;
      
      rule.selectedProductIds = [...productSelectionCache.selectedIds];
      rule.customProducts = true;
      
      saveRulesToLocalStorage();
      closeProductSelectionModal();
      renderNotificationRules();
      
      showAlert('บันทึกการเลือกสินค้าเรียบร้อยแล้ว', 'success');
    }

    // Close product selection modal
    function closeProductSelectionModal() {
      productSelectionModal.style.display = "none";
      currentRuleForProductSelection = null;
      productSelectionSearch.value = "";
    }

    // Render notification rules in fullscreen modal
    function renderNotificationRules() {
      notificationRulesContainer.innerHTML = "";
      
      if (notificationRules.length === 0) {
        notificationRulesContainer.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
            <i class="fas fa-cogs" style="font-size: 60px; color: #ddd; margin-bottom: 20px;"></i>
            <p style="color: #666;">ยังไม่ได้ตั้งค่าการแจ้งเตือน</p>
          </div>
        `;
        return;
      }
      
      // Sort rules by min value
      const sortedRules = [...notificationRules].sort((a, b) => {
        const aMin = a.min === null ? -Infinity : parseFloat(a.min);
        const bMin = b.min === null ? -Infinity : parseFloat(b.min);
        return aMin - bMin;
      });
      
      sortedRules.forEach((rule, index) => {
        // Validate rule
        const errors = validateRule(rule);
        const hasError = errors.length > 0 && rule.notify;
        
        const ruleElement = document.createElement('div');
        ruleElement.className = 'notification-rule-card';
        ruleElement.innerHTML = `
          <div style="position: absolute; top: 10px; right: 10px; font-size: 12px; color: ${rule.color}; font-weight: bold;">
            กฎที่ ${index + 1}
            ${hasError ? '<i class="fas fa-exclamation-circle" style="color: var(--danger); margin-left: 5px;" title="มีข้อผิดพลาด"></i>' : ''}
          </div>
          
          <div class="rule-form-group" style="margin-top: 10px;">
            <div class="custom-notification-toggle" style="${hasError ? 'border: 2px solid var(--danger);' : ''}">
              <div class="toggle-label">
                <i class="fas fa-bell"></i> แจ้งเตือน
                ${rule.customProducts && rule.selectedProductIds && rule.selectedProductIds.length > 0 ? 
                  `<span class="rule-product-count">${rule.selectedProductIds.length}</span>` : ''}
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="notify-${rule.id}" ${rule.notify ? 'checked' : ''} 
                       onchange="toggleNotificationRule(${rule.id}, this.checked)">
                <span class="toggle-slider"></span>
              </label>
            </div>
            ${hasError ? `<div style="color: var(--danger); font-size: 12px; margin-top: 5px;">${errors[0]}</div>` : ''}
          </div>
          
          <div class="rule-form-group">
            <div class="form-label">เลือกรายการสินค้า</div>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
              <div style="flex: 1;">
                <select class="form-input-small" id="productSelectionType-${rule.id}" 
                        onchange="changeProductSelectionType(${rule.id}, this.value)" 
                        style="width: 100%;">
                  <option value="all" ${!rule.customProducts ? 'selected' : ''}>ทุกสินค้า</option>
                  <option value="custom" ${rule.customProducts ? 'selected' : ''}>เลือกสินค้าเฉพาะ</option>
                </select>
              </div>
              ${rule.customProducts ? `
                <button class="btn-info rule-btn" onclick="openProductSelectionForRule(${rule.id})">
                  <i class="fas fa-edit"></i> จัดการ
                </button>
              ` : ''}
            </div>
            ${rule.customProducts && rule.selectedProductIds && rule.selectedProductIds.length > 0 ? 
              `<div style="margin-top: 8px; font-size: 12px; color: var(--primary);">
                <i class="fas fa-box"></i> เลือก ${rule.selectedProductIds.length} รายการ
              </div>` : ''}
          </div>
          
          <div class="rule-form-group">
            <div class="form-label">เงื่อนไข</div>
            <select class="form-input-small" id="operator-${rule.id}" 
                    onchange="updateRuleOperator(${rule.id}, this.value)" 
                    style="width: 100%;">
              <option value="<" ${rule.operator === '<' ? 'selected' : ''}>น้อยกว่า</option>
              <option value=">" ${rule.operator === '>' ? 'selected' : ''}>มากกว่า</option>
              <option value=">= <=" ${rule.operator === '>= <=' ? 'selected' : ''}>ระหว่าง</option>
              <option value=">=" ${rule.operator === '>=' ? 'selected' : ''}>มากกว่าหรือเท่ากับ</option>
              <option value="<=" ${rule.operator === '<=' ? 'selected' : ''}>น้อยกว่าหรือเท่ากับ</option>
            </select>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="rule-form-group">
              <div class="form-label">ค่าต่ำสุด</div>
              <input type="number" class="form-input-small" id="min-${rule.id}" 
                     value="${rule.min !== null ? rule.min : ''}" 
                     placeholder="เว้นว่างถ้าไม่มี"
                     onchange="updateRuleMin(${rule.id}, this.value)"
                     step="1"
                     min="0"
                     style="${rule.operator === '>' || rule.operator === '>=' || rule.operator === '>= <=' ? 'border-color: var(--primary);' : ''}">
            </div>
            
            <div class="rule-form-group">
              <div class="form-label">ค่าสูงสุด</div>
              <input type="number" class="form-input-small" id="max-${rule.id}" 
                     value="${rule.max !== null ? rule.max : ''}" 
                     placeholder="เว้นว่างถ้าไม่มี"
                     onchange="updateRuleMax(${rule.id}, this.value)"
                     step="1"
                     min="0"
                     style="${rule.operator === '<' || rule.operator === '<=' || rule.operator === '>= <=' ? 'border-color: var(--primary);' : ''}">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 80px; gap: 10px;">
            <div class="rule-form-group">
              <div class="form-label">ข้อความแจ้งเตือน</div>
              <input type="text" class="form-input-small" id="message-${rule.id}" 
                     value="${rule.message}" 
                     onchange="updateRuleMessage(${rule.id}, this.value)"
                     style="${hasError ? 'border-color: var(--danger);' : ''}">
            </div>
            
            <div class="rule-form-group">
              <div class="form-label">สี</div>
              <input type="color" class="form-input-small" id="color-${rule.id}" 
                     value="${rule.color}" 
                     style="padding: 0; height: 38px;"
                     onchange="updateRuleColor(${rule.id}, this.value)">
            </div>
          </div>
          
          <div style="margin-top: 15px; display: flex; justify-content: flex-end;">
            <button class="btn-danger rule-btn" onclick="deleteNotificationRule(${rule.id})">
              <i class="fas fa-trash"></i> ลบกฎนี้
            </button>
          </div>
        `;
        notificationRulesContainer.appendChild(ruleElement);
      });
    }

    // Delete notification rule
    function deleteNotificationRule(ruleId) {
      if (!confirm("คุณแน่ใจว่าต้องการลบกฎการแจ้งเตือนนี้?")) return;
      
      notificationRules = notificationRules.filter(r => r.id !== ruleId);
      renderNotificationRules();
      saveRulesToLocalStorage();
      renderProductsGrid(); // Update product statuses
    }

    // Reset to default rules
    function resetToDefaultRules() {
      if (!confirm("คุณแน่ใจว่าต้องการคืนค่ากฎการแจ้งเตือนเป็นค่าเริ่มต้น?")) return;
      
      notificationRules = [
        { 
          id: 1, 
          min: null, 
          max: 10, 
          operator: '<', 
          message: "น้อย", 
          color: "#dc3545", 
          notify: true,
          customProducts: false,
          selectedProductIds: []
        },
        { 
          id: 2, 
          min: 10, 
          max: 80, 
          operator: '>= <=', 
          message: "ปกติ", 
          color: "#28a745", 
          notify: true,
          customProducts: false,
          selectedProductIds: []
        },
        { 
          id: 3, 
          min: 80, 
          max: null, 
          operator: '>', 
          message: "มาก", 
          color: "#ffc107", 
          notify: false,
          customProducts: false,
          selectedProductIds: []
        }
      ];
      nextRuleId = 4;
      
      renderNotificationRules();
      saveRulesToLocalStorage();
      renderProductsGrid(); // Update product statuses
      showAlert("คืนค่ากฎการแจ้งเตือนเป็นค่าเริ่มต้นเรียบร้อยแล้ว", "success");
    }

    // Save notification settings from modal
    function saveNotificationSettings() {
      // Validate all rules
      let hasErrors = false;
      let errorMessages = [];
      
      notificationRules.forEach((rule, index) => {
        const errors = validateRule(rule);
        if (errors.length > 0 && rule.notify) {
          hasErrors = true;
          errorMessages.push(`กฎที่ ${index + 1}: ${errors.join(', ')}`);
        }
      });
      
      if (hasErrors) {
        // Show first 3 errors
        const errorMessage = errorMessages.slice(0, 3).join('\n');
        if (errorMessages.length > 3) {
          showAlert(`${errorMessage}\nและอีก ${errorMessages.length - 3} ข้อผิดพลาด...`, "danger");
        } else {
          showAlert(errorMessage, "danger");
        }
        return;
      }
      
      saveRulesToLocalStorage();
      renderProductsGrid(); // Update product grid with new statuses
      showAlert("บันทึกการตั้งค่าการแจ้งเตือนเรียบร้อยแล้ว", "success");
    }

    // Open fullscreen settings modal
    function openFullscreenSettings() {
      fullscreenSettingsModal.style.display = "block";
      renderNotificationRules();
    }

    // Close fullscreen settings modal
    function closeFullscreenSettings() {
      fullscreenSettingsModal.style.display = "none";
    }

    // ========== UTILITY FUNCTIONS ==========

    // Show loading state
    function showLoading(loadingState) {
      loading.style.display = loadingState ? 'block' : 'none';
    }

    // Show error message
    function showError(message) {
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
          <h3>เกิดข้อผิดพลาด</h3>
          <p>${message}</p>
          <button onclick="initializeApp()" class="btn-primary" style="margin-top: 20px;">
            <i class="fas fa-redo"></i> โหลดใหม่
          </button>
        </div>
      `;
    }

    // Show alert message
    function showAlert(message, type = 'info') {
      // Remove existing alerts
      const existingAlerts = document.querySelectorAll('.custom-alert');
      existingAlerts.forEach(alert => alert.remove());
      
      // Create ID สำหรับ alert
      const alertId = 'alert-' + Date.now();
      
      // Create new alert
      const alert = document.createElement('div');
      alert.id = alertId;
      alert.className = 'custom-alert';
      alert.innerHTML = `
        <i class="fas fa-${
          type === 'success' ? 'check-circle' : 
          type === 'warning' ? 'exclamation-triangle' : 
          type === 'error' ? 'times-circle' : 
          type === 'info' ? 'info-circle' : 'bell'
        }" style="color: ${
          type === 'success' ? 'var(--success)' : 
          type === 'warning' ? 'var(--warning)' : 
          type === 'error' ? 'var(--danger)' : 
          'var(--info)'
        }; font-size: 20px;"></i>
        <span style="flex: 1;">${message}</span>
        <button onclick="document.getElementById('${alertId}').remove()" 
                style="background: none; border: none; color: inherit; cursor: pointer; padding: 5px;">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      // เพิ่มสีพื้นหลังตามประเภท
      alert.style.backgroundColor = type === 'success' ? '#d4edda' : 
                                   type === 'warning' ? '#fff3cd' : 
                                   type === 'error' ? '#f8d7da' : '#d1ecf1';
      alert.style.color = type === 'success' ? '#155724' : 
                          type === 'warning' ? '#856404' : 
                          type === 'error' ? '#721c24' : '#0c5460';
      alert.style.border = type === 'success' ? '1px solid #c3e6cb' : 
                           type === 'warning' ? '1px solid #ffeeba' : 
                           type === 'error' ? '1px solid #f5c6cb' : '1px solid #bee5eb';
      
      document.body.appendChild(alert);
      
      // ลบอัตโนมัติหลังจาก 5 วินาที
      setTimeout(() => {
        const alertElement = document.getElementById(alertId);
        if (alertElement) {
          alertElement.remove();
        }
      }, 5000);
    }
  </script>
</body>
</html>