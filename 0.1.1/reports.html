<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>รายงานการขาย - ร้านสุภาวดี</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #d63384;
      --secondary: #9c27b0;
      --light-pink: #fce7f3;
      --light-purple: #f3e8fd;
      --gray: #6c757d;
      --light-gray: #f8f9fa;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --white: #FFFFFF;
      --text-dark: #212121;
      --border-color: #e0e0e0;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    }
    
    body { 
      background: linear-gradient(135deg, var(--light-pink), var(--light-purple)); 
      color: var(--text-dark); 
      line-height: 1.6; 
      padding: 20px; 
      min-height: 100vh; 
    }
    
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      background: var(--white); 
      padding: 20px; 
      border-radius: 15px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
    }
    
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 20px; 
      padding: 20px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-radius: 12px;
    }
    
    .page-title { 
      display: flex; 
      align-items: center; 
      color: white;
    }
    
    .page-title i { 
      font-size: 28px; 
      margin-right: 12px; 
    }
    
    .page-title h1 { 
      font-size: 24px; 
      font-weight: 700; 
      margin: 0;
    }
    
    .page-subtitle {
      margin: 5px 0 0 0;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .back-btn { 
      display: inline-flex; 
      align-items: center; 
      padding: 8px 16px; 
      background: rgba(255,255,255,0.2); 
      color: white; 
      text-decoration: none; 
      border-radius: 6px; 
      font-weight: 600; 
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 600;
      border-radius: 6px 6px 0 0;
      margin-right: 5px;
      color: var(--gray);
    }
    
    .tab.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
      background-color: rgba(214, 51, 132, 0.05);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      text-align: center;
      border-left: 4px solid var(--primary);
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin: 8px 0;
    }
    
    .stat-label {
      color: var(--gray);
      font-size: 13px;
    }
    
    .filter-section {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      min-width: 150px;
    }
    
    .filter-label {
      margin-bottom: 4px;
      font-weight: 600;
      color: var(--text-dark);
      font-size: 13px;
    }
    
    .filter-select, .filter-input {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 13px;
      background-color: white;
    }
    
    .date-input {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 13px;
    }
    
    button { 
      padding: 8px 14px; 
      cursor: pointer; 
      border: none; 
      border-radius: 6px; 
      font-weight: 600; 
      font-size: 13px; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
    }
    
    button i { 
      margin-right: 6px; 
    }
    
    .apply-btn { 
      background: linear-gradient(to right, var(--primary), var(--secondary)); 
      color: white; 
      height: 36px;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
      border-radius: 8px; 
      overflow: hidden; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border: 1px solid var(--border-color);
    }
    
    table th { 
      background: linear-gradient(to right, var(--primary), var(--secondary)); 
      color: var(--white); 
      padding: 12px; 
      text-align: center; 
      font-weight: 600; 
    }
    
    table td { 
      padding: 10px 12px; 
      text-align: center; 
      border-bottom: 1px solid var(--border-color); 
    }
    
    table tr:nth-child(even) { 
      background-color: var(--light-gray); 
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--gray);
      font-size: 16px;
    }
    
    .loading i {
      margin-right: 8px;
    }
    
    .no-data {
      text-align: center;
      padding: 30px 15px;
      color: var(--gray);
    }
    
    .no-data i {
      font-size: 40px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    
    .report-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .summary-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .summary-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
    }
    
    .summary-title i {
      margin-right: 8px;
    }
    
    .summary-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 8px;
    }
    
    .quick-filter {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .quick-filter-btn {
      background: var(--light-gray);
      color: var(--text-dark);
      border: 1px solid var(--border-color);
    }
    
    .quick-filter-btn.active {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
    }
    
    @media (max-width: 768px) { 
      .header {
        flex-direction: column; 
        text-align: center; 
        gap: 12px; 
      } 
      
      table {
        display: block; 
        overflow-x: auto; 
      } 
      
      .tabs {
        flex-direction: column;
      }
      
      .tab {
        border-radius: 6px;
        margin-bottom: 4px;
        border-bottom: none;
      }
      
      .tab.active {
        border-bottom: none;
        background-color: rgba(214, 51, 132, 0.1);
      }
      
      .filter-section {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-group {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="page-title">
          <i class="fas fa-chart-line"></i>
          <h1>รายงานการขาย</h1>
        </div>
        <p class="page-subtitle">ร้านเครื่องสำอางคุณสุภาวดี</p>
      </div>
      <div>
        <a href="admin.html" class="back-btn">
          <i class="fas fa-arrow-left"></i> กลับสู่หน้าหลัก
        </a>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('daily')">
        <i class="fas fa-calendar-day"></i> รายงานรายวัน
      </div>
      <div class="tab" onclick="switchTab('product')">
        <i class="fas fa-box"></i> รายงานตามสินค้า
      </div>
      <div class="tab" onclick="switchTab('monthly')">
        <i class="fas fa-calendar-alt"></i> รายงานรายเดือน
      </div>
    </div>

    <!-- รายงานรายวัน -->
    <div id="daily-tab" class="tab-content active">
      <div class="quick-filter">
        <button class="quick-filter-btn active" onclick="setQuickFilter('today', 'daily')">วันนี้</button>
        <button class="quick-filter-btn" onclick="setQuickFilter('week', 'daily')">7 วันล่าสุด</button>
        <button class="quick-filter-btn" onclick="setQuickFilter('month', 'daily')">เดือนนี้</button>
      </div>
      
      <div class="filter-section">
        <div class="filter-group">
          <label class="filter-label">วันที่เริ่มต้น</label>
          <input type="date" id="daily-start-date" class="date-input">
        </div>
        <div class="filter-group">
          <label class="filter-label">วันที่สิ้นสุด</label>
          <input type="date" id="daily-end-date" class="date-input">
        </div>
        <div class="filter-actions">
          <button class="apply-btn" onclick="loadDailyReport()">
            <i class="fas fa-filter"></i> ประมวลผล
          </button>
        </div>
      </div>

      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-label">ยอดขายรวม</div>
          <div class="stat-value" id="daily-total-sales">0</div>
          <div class="stat-label">บาท</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">จำนวนรายการขาย</div>
          <div class="stat-value" id="daily-total-orders">0</div>
          <div class="stat-label">รายการ</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">จำนวนสินค้าที่ขาย</div>
          <div class="stat-value" id="daily-total-items">0</div>
          <div class="stat-label">ชิ้น</div>
        </div>
      </div>

      <table id="daily-table">
        <thead>
          <tr>
            <th>วันที่</th>
            <th>จำนวนรายการขาย</th>
            <th>จำนวนสินค้า</th>
            <th>ยอดขายรวม</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="loading" id="daily-loading">
        <i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...
      </div>
      <div class="no-data" id="daily-no-data" style="display: none;">
        <i class="fas fa-chart-line"></i>
        <p>ไม่พบข้อมูลการขายในช่วงวันที่เลือก</p>
      </div>
    </div>

    <!-- รายงานตามสินค้า -->
    <div id="product-tab" class="tab-content">
      <div class="quick-filter">
        <button class="quick-filter-btn active" onclick="setQuickFilter('month', 'product')">เดือนนี้</button>
        <button class="quick-filter-btn" onclick="setQuickFilter('quarter', 'product')">ไตรมาสนี้</button>
        <button class="quick-filter-btn" onclick="setQuickFilter('year', 'product')">ปีนี้</button>
      </div>
      
      <div class="filter-section">
        <div class="filter-group">
          <label class="filter-label">วันที่เริ่มต้น</label>
          <input type="date" id="product-start-date" class="date-input">
        </div>
        <div class="filter-group">
          <label class="filter-label">วันที่สิ้นสุด</label>
          <input type="date" id="product-end-date" class="date-input">
        </div>
        <div class="filter-actions">
          <button class="apply-btn" onclick="loadProductReport()">
            <i class="fas fa-filter"></i> ประมวลผล
          </button>
        </div>
      </div>

      <div class="report-summary">
        <div class="summary-card">
          <div class="summary-title">
            <i class="fas fa-box"></i> สินค้าขายดีที่สุด
          </div>
          <div class="summary-value" id="top-product-name">-</div>
          <div class="summary-change" id="top-product-sales">ยอดขาย: 0 บาท</div>
        </div>
        <div class="summary-card">
          <div class="summary-title">
            <i class="fas fa-star"></i> สินค้าอันดับ 2
          </div>
          <div class="summary-value" id="second-product-name">-</div>
          <div class="summary-change" id="second-product-sales">ยอดขาย: 0 บาท</div>
        </div>
      </div>

      <table id="product-table">
        <thead>
          <tr>
            <th>อันดับ</th>
            <th>ชื่อสินค้า</th>
            <th>จำนวนที่ขาย</th>
            <th>ยอดขายรวม</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="loading" id="product-loading">
        <i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...
      </div>
      <div class="no-data" id="product-no-data" style="display: none;">
        <i class="fas fa-box-open"></i>
        <p>ไม่พบข้อมูลการขายในช่วงวันที่เลือก</p>
      </div>
    </div>

    <!-- รายงานรายเดือน -->
    <div id="monthly-tab" class="tab-content">
      <div class="filter-section">
        <div class="filter-group">
          <label class="filter-label">ปี</label>
          <select id="monthly-year" class="filter-select">
            <!-- จะเติมข้อมูลปีด้วย JavaScript -->
          </select>
        </div>
        <div class="filter-actions">
          <button class="apply-btn" onclick="loadMonthlyReport()">
            <i class="fas fa-filter"></i> ประมวลผล
          </button>
        </div>
      </div>

      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-label">ยอดขายรวมทั้งปี</div>
          <div class="stat-value" id="monthly-total-sales">0</div>
          <div class="stat-label">บาท</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">เดือนที่ขายดีที่สุด</div>
          <div class="stat-value" id="monthly-best-month">-</div>
          <div class="stat-label" id="monthly-best-amount">0 บาท</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ยอดขายเฉลี่ยต่อเดือน</div>
          <div class="stat-value" id="monthly-avg-sales">0</div>
          <div class="stat-label">บาท</div>
        </div>
      </div>

      <table id="monthly-table">
        <thead>
          <tr>
            <th>เดือน</th>
            <th>จำนวนรายการขาย</th>
            <th>จำนวนสินค้า</th>
            <th>ยอดขายรวม</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="loading" id="monthly-loading">
        <i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...
      </div>
      <div class="no-data" id="monthly-no-data" style="display: none;">
        <i class="fas fa-calendar-times"></i>
        <p>ไม่พบข้อมูลการขายในปีที่เลือก</p>
      </div>
    </div>
  </div>

  <script>
    // ตั้งค่า Supabase
    const SUPABASE_URL = "https://rhcevdopguxtzupuxipk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoY2V2ZG9wZ3V4dHp1cHV4aXBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MjEyNDUsImV4cCI6MjA3MzM5NzI0NX0.Ot6aYOsIRgKjMWrbjPTEXuaWOqXYxYHiXKN1c7AhPyQ";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ตัวแปรเก็บข้อมูล
    let salesData = [];
    let currentYear = new Date().getFullYear();

    // เริ่มต้นแอปพลิเคชันเมื่อโหลดหน้าเว็บ
    document.addEventListener("DOMContentLoaded", function() {
      initializeApp();
    });

    // ฟังก์ชันเริ่มต้นแอปพลิเคชัน
    async function initializeApp() {
      // ตั้งค่าเริ่มต้นสำหรับวันที่ในฟิลด์กรอง
      const today = new Date();
      const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      
      // ตั้งค่าวันที่เริ่มต้นและสิ้นสุดสำหรับรายงาน
      document.getElementById('daily-start-date').value = formatDate(firstDayOfMonth);
      document.getElementById('daily-end-date').value = formatDate(today);
      document.getElementById('product-start-date').value = formatDate(firstDayOfMonth);
      document.getElementById('product-end-date').value = formatDate(today);
      
      // เติมข้อมูลปีในรายงานรายเดือน
      populateYearDropdown();
      
      // โหลดข้อมูลเริ่มต้น
      await loadSalesData();
      loadDailyReport();
    }

    // โหลดข้อมูลการขายจาก Supabase
    async function loadSalesData() {
      try {
        // ดึงข้อมูลการขายทั้งหมด
        const { data, error } = await client
          .from("sales")
          .select("id, product_id, qty, total_price, product_name, created_at, sale_date")
          .order('created_at', { ascending: false });

        if (error) throw error;
        
        salesData = data || [];
        console.log("โหลดข้อมูลการขายสำเร็จ:", salesData.length, "รายการ");
      } catch (err) {
        console.error("โหลดข้อมูลการขายล้มเหลว:", err);
        salesData = [];
      }
    }

    // ฟังก์ชันสลับแท็บ
    function switchTab(tabName) {
      // ซ่อนแท็บทั้งหมด
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // อัพเดทแท็บที่ active
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // แสดงแท็บที่เลือก
      document.getElementById(`${tabName}-tab`).classList.add('active');
      event.currentTarget.classList.add('active');
      
      // โหลดข้อมูลสำหรับแท็บที่เลือก
      if (tabName === 'daily') {
        loadDailyReport();
      } else if (tabName === 'product') {
        loadProductReport();
      } else if (tabName === 'monthly') {
        loadMonthlyReport();
      }
    }

    // ตั้งค่ากรองแบบรวดเร็ว
    function setQuickFilter(type, reportType) {
      const today = new Date();
      let startDate, endDate;
      
      switch(type) {
        case 'today':
          startDate = today;
          endDate = today;
          break;
        case 'week':
          const weekAgo = new Date(today);
          weekAgo.setDate(today.getDate() - 7);
          startDate = weekAgo;
          endDate = today;
          break;
        case 'month':
          const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
          startDate = firstDay;
          endDate = today;
          break;
        case 'quarter':
          const quarter = Math.floor(today.getMonth() / 3);
          const firstDayQuarter = new Date(today.getFullYear(), quarter * 3, 1);
          startDate = firstDayQuarter;
          endDate = today;
          break;
        case 'year':
          const firstDayYear = new Date(today.getFullYear(), 0, 1);
          startDate = firstDayYear;
          endDate = today;
          break;
      }
      
      // อัพเดทปุ่มกรอง
      document.querySelectorAll(`#${reportType}-tab .quick-filter-btn`).forEach(btn => {
        btn.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      
      // อัพเดทฟิลด์วันที่
      if (reportType === 'daily' || reportType === 'product') {
        document.getElementById(`${reportType}-start-date`).value = formatDate(startDate);
        document.getElementById(`${reportType}-end-date`).value = formatDate(endDate);
      }
      
      // โหลดรายงานใหม่
      if (reportType === 'daily') {
        loadDailyReport();
      } else if (reportType === 'product') {
        loadProductReport();
      }
    }

    // รายงานการขายรายวัน
    function loadDailyReport() {
      const startDate = document.getElementById('daily-start-date').value;
      const endDate = document.getElementById('daily-end-date').value;
      
      if (!startDate || !endDate) {
        alert('กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด');
        return;
      }
      
      // แสดงสถานะกำลังโหลด
      document.getElementById('daily-loading').style.display = 'block';
      document.getElementById('daily-no-data').style.display = 'none';
      
      // กรองข้อมูลตามช่วงวันที่
      const filteredData = salesData.filter(sale => {
        const saleDate = sale.sale_date || sale.created_at.split('T')[0];
        return saleDate >= startDate && saleDate <= endDate;
      });
      
      // กลุ่มข้อมูลตามวัน
      const dailyData = {};
      filteredData.forEach(sale => {
        const saleDate = sale.sale_date || sale.created_at.split('T')[0];
        if (!dailyData[saleDate]) {
          dailyData[saleDate] = {
            orders: 0,
            items: 0,
            totalSales: 0
          };
        }
        
        dailyData[saleDate].orders += 1;
        dailyData[saleDate].items += sale.qty;
        dailyData[saleDate].totalSales += parseFloat(sale.total_price);
      });
      
      // แปลงเป็นอาร์เรย์และเรียงลำดับตามวันที่
      let dailyArray = Object.keys(dailyData).map(date => {
        return {
          date,
          orders: dailyData[date].orders,
          items: dailyData[date].items,
          totalSales: dailyData[date].totalSales
        };
      }).sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // อัพเดทสถิติสรุป
      const totalSales = dailyArray.reduce((sum, day) => sum + day.totalSales, 0);
      const totalOrders = dailyArray.reduce((sum, day) => sum + day.orders, 0);
      const totalItems = dailyArray.reduce((sum, day) => sum + day.items, 0);
      
      document.getElementById('daily-total-sales').textContent = totalSales.toFixed(2);
      document.getElementById('daily-total-orders').textContent = totalOrders;
      document.getElementById('daily-total-items').textContent = totalItems;
      
      // อัพเดทตาราง
      const tbody = document.querySelector('#daily-table tbody');
      tbody.innerHTML = '';
      
      if (dailyArray.length === 0) {
        document.getElementById('daily-loading').style.display = 'none';
        document.getElementById('daily-no-data').style.display = 'block';
        return;
      }
      
      dailyArray.forEach(day => {
        tbody.innerHTML += `
          <tr>
            <td>${formatDateDisplay(day.date)}</td>
            <td>${day.orders}</td>
            <td>${day.items}</td>
            <td>${day.totalSales.toFixed(2)}</td>
          </tr>
        `;
      });
      
      // ซ่อนสถานะกำลังโหลด
      document.getElementById('daily-loading').style.display = 'none';
    }

    // รายงานตามสินค้า
    function loadProductReport() {
      const startDate = document.getElementById('product-start-date').value;
      const endDate = document.getElementById('product-end-date').value;
      
      if (!startDate || !endDate) {
        alert('กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด');
        return;
      }
      
      // แสดงสถานะกำลังโหลด
      document.getElementById('product-loading').style.display = 'block';
      document.getElementById('product-no-data').style.display = 'none';
      
      // กรองข้อมูลตามช่วงวันที่
      const filteredData = salesData.filter(sale => {
        const saleDate = sale.sale_date || sale.created_at.split('T')[0];
        return saleDate >= startDate && saleDate <= endDate;
      });
      
      // กลุ่มข้อมูลตามสินค้า
      const productData = {};
      filteredData.forEach(sale => {
        const productName = sale.product_name;
        if (!productData[productName]) {
          productData[productName] = {
            quantity: 0,
            totalSales: 0
          };
        }
        
        productData[productName].quantity += sale.qty;
        productData[productName].totalSales += parseFloat(sale.total_price);
      });
      
      // แปลงเป็นอาร์เรย์
      let productArray = Object.keys(productData).map(name => {
        return {
          name,
          quantity: productData[name].quantity,
          totalSales: productData[name].totalSales
        };
      }).sort((a, b) => b.totalSales - a.totalSales);
      
      // อัพเดทข้อมูลสรุป
      if (productArray.length > 0) {
        const topProduct = productArray[0];
        const secondProduct = productArray[1] || { name: '-', totalSales: 0 };
        
        document.getElementById('top-product-name').textContent = topProduct.name;
        document.getElementById('top-product-sales').textContent = `ยอดขาย: ${topProduct.totalSales.toFixed(2)} บาท`;
        
        document.getElementById('second-product-name').textContent = secondProduct.name;
        document.getElementById('second-product-sales').textContent = `ยอดขาย: ${secondProduct.totalSales.toFixed(2)} บาท`;
      } else {
        document.getElementById('top-product-name').textContent = '-';
        document.getElementById('top-product-sales').textContent = 'ยอดขาย: 0 บาท';
        document.getElementById('second-product-name').textContent = '-';
        document.getElementById('second-product-sales').textContent = 'ยอดขาย: 0 บาท';
      }
      
      // อัพเดทตาราง
      const tbody = document.querySelector('#product-table tbody');
      tbody.innerHTML = '';
      
      if (productArray.length === 0) {
        document.getElementById('product-loading').style.display = 'none';
        document.getElementById('product-no-data').style.display = 'block';
        return;
      }
      
      productArray.forEach((product, index) => {
        tbody.innerHTML += `
          <tr>
            <td>${index + 1}</td>
            <td>${product.name}</td>
            <td>${product.quantity}</td>
            <td>${product.totalSales.toFixed(2)}</td>
          </tr>
        `;
      });
      
      // ซ่อนสถานะกำลังโหลด
      document.getElementById('product-loading').style.display = 'none';
    }

    // รายงานการขายรายเดือน
    function loadMonthlyReport() {
      const year = document.getElementById('monthly-year').value;
      
      if (!year) {
        alert('กรุณาเลือกปี');
        return;
      }
      
      // แสดงสถานะกำลังโหลด
      document.getElementById('monthly-loading').style.display = 'block';
      document.getElementById('monthly-no-data').style.display = 'none';
      
      // กรองข้อมูลตามปี
      const filteredData = salesData.filter(sale => {
        const saleDate = sale.sale_date || sale.created_at.split('T')[0];
        return saleDate.startsWith(year);
      });
      
      // กลุ่มข้อมูลตามเดือน
      const monthlyData = {};
      filteredData.forEach(sale => {
        const saleDate = sale.sale_date || sale.created_at.split('T')[0];
        const month = saleDate.substring(0, 7); // YYYY-MM
        
        if (!monthlyData[month]) {
          monthlyData[month] = {
            orders: 0,
            items: 0,
            totalSales: 0
          };
        }
        
        monthlyData[month].orders += 1;
        monthlyData[month].items += sale.qty;
        monthlyData[month].totalSales += parseFloat(sale.total_price);
      });
      
      // แปลงเป็นอาร์เรย์และเรียงลำดับตามเดือน
      let monthlyArray = Object.keys(monthlyData).map(month => {
        return {
          month,
          orders: monthlyData[month].orders,
          items: monthlyData[month].items,
          totalSales: monthlyData[month].totalSales
        };
      }).sort((a, b) => b.month.localeCompare(a.month));
      
      // อัพเดทสถิติสรุป
      const totalSales = monthlyArray.reduce((sum, month) => sum + month.totalSales, 0);
      const avgSales = monthlyArray.length > 0 ? totalSales / monthlyArray.length : 0;
      
      // หาเดือนที่ขายดีที่สุด
      let bestMonth = '-';
      let bestAmount = 0;
      if (monthlyArray.length > 0) {
        const best = monthlyArray.reduce((prev, current) => 
          prev.totalSales > current.totalSales ? prev : current
        );
        bestMonth = getMonthName(best.month);
        bestAmount = best.totalSales;
      }
      
      document.getElementById('monthly-total-sales').textContent = totalSales.toFixed(2);
      document.getElementById('monthly-best-month').textContent = bestMonth;
      document.getElementById('monthly-best-amount').textContent = bestAmount.toFixed(2) + ' บาท';
      document.getElementById('monthly-avg-sales').textContent = avgSales.toFixed(2);
      
      // อัพเดทตาราง
      const tbody = document.querySelector('#monthly-table tbody');
      tbody.innerHTML = '';
      
      if (monthlyArray.length === 0) {
        document.getElementById('monthly-loading').style.display = 'none';
        document.getElementById('monthly-no-data').style.display = 'block';
        return;
      }
      
      monthlyArray.forEach((monthData) => {
        tbody.innerHTML += `
          <tr>
            <td>${getMonthName(monthData.month)}</td>
            <td>${monthData.orders}</td>
            <td>${monthData.items}</td>
            <td>${monthData.totalSales.toFixed(2)}</td>
          </tr>
        `;
      });
      
      // ซ่อนสถานะกำลังโหลด
      document.getElementById('monthly-loading').style.display = 'none';
    }

    // ฟังก์ชันช่วยเหลือ
    function formatDate(date) {
      const d = new Date(date);
      let month = '' + (d.getMonth() + 1);
      let day = '' + d.getDate();
      const year = d.getFullYear();

      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;

      return [year, month, day].join('-');
    }

    function formatDateDisplay(dateString) {
      const date = new Date(dateString);
      const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
      return date.toLocaleDateString('th-TH', options);
    }

    function getMonthName(monthString) {
      const [year, month] = monthString.split('-');
      const monthNames = [
        'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
        'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
      ];
      return `${monthNames[parseInt(month) - 1]} ${parseInt(year)}`;
    }

    function populateYearDropdown() {
      const select = document.getElementById('monthly-year');
      const currentYear = new Date().getFullYear();
      
      // เพิ่ม 3 ปีย้อนหลัง
      for (let year = currentYear - 3; year <= currentYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) {
          option.selected = true;
        }
        select.appendChild(option);
      }
    }
  </script>
</body>
</html>