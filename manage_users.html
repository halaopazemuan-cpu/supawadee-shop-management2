<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ระบบจัดการพนักงาน - ร้านสุภาวดี</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{ 
      --primary:#d63384; 
      --secondary:#9c27b0; 
      --primary-light:#fce7f3;
      --secondary-light:#f3e8fd;
      --gray:#6c757d; 
      --light:#f8f9fa; 
      --light-gray:#e9ecef; 
      --dark:#212529; 
      --success:#28a745;
      --info:#17a2b8;
      --warning:#ffc107;
      --danger:#dc3545;
    }
    *{ box-sizing:border-box; transition: all 0.25s ease; }
    body{ 
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin:0; 
      background: linear-gradient(135deg, var(--primary-light), var(--secondary-light)); 
      padding:20px; 
      color:#333; 
      min-height:100vh; 
    }
    .container{ 
      max-width:1200px; 
      margin:0 auto; 
      background:white; 
      padding:24px; 
      border-radius:14px; 
      box-shadow:0 10px 30px rgba(0,0,0,0.08); 
    }
    .topbar{ 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      gap:12px; 
      padding:14px 20px; 
      border-radius:12px; 
      background: linear-gradient(90deg, #ffffff, var(--primary-light)); 
      box-shadow:0 6px 22px rgba(214, 51, 132, 0.1); 
      margin-bottom:20px; 
    }
    .brand-icon{ 
      width:40px; 
      height:40px; 
      display:inline-flex; 
      align-items:center; 
      justify-content:center; 
      border-radius:10px; 
      background: linear-gradient(135deg, var(--primary), var(--secondary)); 
      color:white; 
      font-size:18px; 
    }
    header{ 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      margin-bottom:20px; 
      padding-bottom:10px; 
      border-bottom:2px solid var(--primary-light); 
    }
    .header-title{ 
      color:var(--primary); 
      font-weight:700; 
      display:flex; 
      gap:12px; 
      align-items:center;
    }
    .form-grid{ 
      display:grid; 
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); 
      gap:12px; 
      margin:18px 0; 
      padding:18px; 
      background:var(--primary-light); 
      border-radius:10px; 
      box-shadow:0 3px 12px rgba(214, 51, 132, 0.08); 
    }
    input[type="text"], select{ 
      width:100%; 
      padding:12px 14px; 
      border:1px solid #f0b6d5; 
      border-radius:8px; 
      font-size:15px; 
      background: white;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(214, 51, 132, 0.1);
    }
    .stats-container{ 
      display:grid; 
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); 
      gap:16px; 
      margin-bottom:18px; 
    }
    .stat-card{ 
      background:white; 
      border-radius:10px; 
      padding:16px; 
      box-shadow:0 6px 18px rgba(214, 51, 132, 0.08); 
      display:flex; 
      flex-direction:column; 
      align-items:center;
      border-left: 4px solid var(--primary);
      transition: transform 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(214, 51, 132, 0.15);
    }
    .stat-card i {
      font-size: 32px;
      color: var(--primary);
      margin-bottom: 10px;
    }
    .stat-card h3 {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 8px;
      text-align: center;
    }
    .stat-card p {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }
    table{ 
      width:100%; 
      border-collapse:collapse; 
      margin-top:14px; 
      border-radius:8px; 
      overflow:hidden; 
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
      border: 1px solid var(--primary-light);
    }
    table th{ 
      background: linear-gradient(to right, var(--primary), var(--secondary)); 
      color:white; 
      padding:14px; 
      text-align:center; 
      font-weight:600;
    }
    table td{ 
      padding:12px; 
      text-align:center; 
      border-bottom:1px solid var(--primary-light); 
    }
    table tr:nth-child(even) {
      background-color: var(--primary-light);
    }
    table tr:hover {
      background-color: rgba(214, 51, 132, 0.05);
    }
    .badge{ 
      padding:6px 10px; 
      border-radius:40px; 
      font-size:12px; 
      font-weight:700; 
      display: inline-block;
    }
    .badge-employee{ 
      background:rgba(40, 167, 69, 0.1); 
      color:var(--success);
      border: 1px solid rgba(40, 167, 69, 0.3);
    }
    .badge-admin{ 
      background:rgba(214, 51, 132, 0.1); 
      color:var(--primary);
      border: 1px solid rgba(214, 51, 132, 0.3);
    }
    .notification{ 
      position:fixed; 
      top:20px; 
      right:20px; 
      padding:12px 16px; 
      border-radius:8px; 
      color:white; 
      font-weight:700; 
      z-index:1000; 
      opacity:0; 
      transform:translateY(-18px); 
      transition:all 0.28s ease; 
      display:flex; 
      align-items:center; 
      gap:8px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 350px;
    }
    .notification.show{ 
      opacity:1; 
      transform:translateY(0); 
    }
    .notification.success{ 
      background:linear-gradient(to right, var(--success), #218838); 
    }
    .notification.error{ 
      background:linear-gradient(to right, var(--danger), #c82333); 
    }
    .notification.info {
      background: linear-gradient(to right, var(--primary), var(--secondary));
    }
    .modal{ 
      display:none; 
      position:fixed; 
      top:0; 
      left:0; 
      width:100%; 
      height:100%; 
      background:rgba(0,0,0,0.5); 
      z-index:1001; 
      justify-content:center; 
      align-items:center; 
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content{ 
      background:white; 
      padding:24px; 
      border-radius:12px; 
      width:90%; 
      max-width:520px; 
      box-shadow:0 8px 30px rgba(0,0,0,0.2); 
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-content h3 {
      color: var(--primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .modal-buttons{ 
      display:flex; 
      justify-content:flex-end; 
      gap:8px; 
      margin-top:20px; 
    }
    .loading{ 
      display:inline-block; 
      width:18px; 
      height:18px; 
      border:3px solid rgba(255,255,255,0.35); 
      border-radius:50%; 
      border-top-color:#fff; 
      animation:spin 0.9s linear infinite; 
    }
    @keyframes spin{ 
      to{ transform:rotate(360deg); } 
    }
    @media (max-width:768px){ 
      .container{ 
        padding:16px; 
      } 
      header{ 
        flex-direction:column; 
        align-items:flex-start; 
        gap: 15px;
      } 
      table{ 
        display:block; 
        overflow-x:auto; 
      } 
      .form-grid {
        grid-template-columns: 1fr;
      }
      .topbar {
        flex-direction: column;
        gap: 15px;
      }
    }
    button{ 
      padding:10px 18px; 
      border-radius:8px; 
      border:none; 
      cursor:pointer; 
      font-weight:600; 
      display:inline-flex; 
      align-items:center; 
      gap:8px; 
      transition: all 0.3s ease;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    button:active {
      transform: translateY(0);
    }
    .add{ 
      background: linear-gradient(to right, var(--success), #218838); 
      color:white; 
    }
    .edit{ 
      background: linear-gradient(to right, var(--info), #138496); 
      color:white; 
    }
    .delete{ 
      background: linear-gradient(to right, var(--danger), #c82333); 
      color:white; 
    }
    .btn {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
    }
    .btn-secondary {
      background: var(--gray);
      color: white;
    }
    .role-display{ 
      padding:12px 14px; 
      background:#f8f9fa; 
      border:1px solid #f0b6d5; 
      border-radius:8px; 
      color:var(--primary); 
      font-weight:600; 
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .role-display i {
      color: var(--primary);
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary);
    }
    footer {
      text-align: center;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid var(--primary-light);
      color: var(--gray);
      font-size: 14px;
    }
    .password-cell {
      font-family: monospace;
      background: var(--light);
      border-radius: 4px;
      padding: 8px;
      display: inline-block;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div style="display:flex;gap:12px;align-items:center;">
      <div class="brand-icon"><i class="fas fa-store"></i></div>
      <div>
        <div style="font-weight: 600; color: var(--primary);">ระบบบริหารจัดการร้านสุภาวดี</div>
        <div style="font-size:12px;color:var(--gray);font-weight:600;">Dashboard • จัดการพนักงาน</div>
      </div>
    </div>
    <div style="display:flex;gap:12px;align-items:center;">
      <div style="display:flex;gap:8px;align-items:center;background:var(--primary-light);padding:6px 12px;border-radius:20px;border:1px solid rgba(214, 51, 132, 0.2);">
        <img src="https://ui-avatars.com/api/?name=Admin&background=d63384&color=fff&size=128" 
             class="user-avatar" alt="Admin">
        <div style="line-height:1;">
          <div style="font-size:13px;color:var(--primary);font-weight:600;">ผู้ดูแลระบบ</div>
          <small style="color:var(--gray);">(admin)</small>
        </div>
      </div>
      <button class="btn" onclick="window.location.href='admin.html'">
        <i class="fas fa-arrow-left"></i>กลับสู่หน้าหลัก
      </button>
    </div>
  </div>

  <div class="container">
    <header>
      <h1 class="header-title">
        <i class="fas fa-users-cog" style="color: var(--primary);"></i>&nbsp;ระบบจัดการพนักงาน
      </h1>
      <div style="display:flex;align-items:center;gap:10px;">
        <img src="https://ui-avatars.com/api/?name=Admin&background=d63384&color=fff&size=128" 
             class="user-avatar" alt="Admin">
        <div style="color:var(--gray)">
          <strong style="color: var(--primary);">ผู้ดูแลระบบ</strong>
          <div style="font-size:13px;">Administrator</div>
        </div>
      </div>
    </header>

    <div class="stats-container">
      <div class="stat-card">
        <i class="fas fa-users"></i>
        <h3>จำนวนพนักงานทั้งหมด</h3>
        <p id="totalEmployees">0</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-calendar-day"></i>
        <h3>พนักงานที่ถูกเพิ่มวันนี้</h3>
        <p id="todayAdded">0</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-user-shield"></i>
        <h3>ผู้ดูแลระบบ</h3>
        <p id="adminCount">1</p>
      </div>
    </div>

    <div class="form-grid">
      <input type="text" id="username" placeholder="ชื่อผู้ใช้" autocomplete="off">
      <input type="text" id="password" placeholder="รหัสผ่าน" autocomplete="off">
      <div class="role-display">
        <i class="fas fa-user-tie"></i>พนักงาน
      </div>
      <button class="add" id="addButton" onclick="addUser()">
        <i class="fas fa-user-plus"></i>เพิ่มพนักงาน
      </button>
    </div>

    <table id="userTable">
      <thead>
        <tr>
          <th>ลำดับ</th>
          <th>ชื่อผู้ใช้</th>
          <th>รหัสผ่าน</th>
          <th>สิทธิ์</th>
          <th>วันที่สร้าง</th>
          <th>จัดการ</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="6" style="text-align:center;padding:30px;">
            <div class="loading" style="border-color: var(--primary) rgba(214, 51, 132, 0.1) rgba(214, 51, 132, 0.1); margin: 0 auto;"></div>
            <p style="margin-top: 10px; color: var(--gray);">กำลังโหลดข้อมูลพนักงาน...</p>
          </td>
        </tr>
      </tbody>
    </table>

    <footer>
      <p>ระบบจัดการพนักงาน &copy; 2023 | ร้านเครื่องสำอางคุณสุภาวดี</p>
    </footer>
  </div>

  <div id="notification" class="notification"></div>

  <!-- delete modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-exclamation-triangle"></i> ยืนยันการลบผู้ใช้</h3>
      <p id="modalMessage">คุณแน่ใจหรือไม่ที่จะลบพนักงานนี้?</p>
      <div class="modal-buttons">
        <button class="delete" id="confirmDeleteButton" onclick="confirmDelete()">
          <span id="deleteButtonText"><i class="fas fa-trash"></i> ลบ</span>
        </button>
        <button class="btn-secondary" onclick="closeModal()">
          <i class="fas fa-times"></i> ยกเลิก
        </button>
      </div>
    </div>
  </div>

  <!-- edit modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-edit"></i> แก้ไขข้อมูลผู้ใช้</h3>
      <div class="form-grid" style="margin: 0; padding: 0; box-shadow: none; background: transparent;">
        <input type="hidden" id="editId">
        <input type="text" id="editUsername" placeholder="ชื่อผู้ใช้" autocomplete="off">
        <input type="text" id="editPassword" placeholder="รหัสผ่าน (เว้นว่างหากไม่ต้องการเปลี่ยน)" autocomplete="off">
        <div class="role-display">
          <i class="fas fa-user-tie"></i>พนักงาน
        </div>
      </div>
      <div class="modal-buttons">
        <button class="edit" id="saveEditButton" onclick="saveEdit()">
          <span id="saveButtonText"><i class="fas fa-save"></i> บันทึก</span>
        </button>
        <button class="btn-secondary" onclick="closeEditModal()">
          <i class="fas fa-times"></i> ยกเลิก
        </button>
      </div>
    </div>
  </div>

  <script>
    // Globals
    let supabaseClient = null;
    let users = []; // users[].id stored as string for UI
    let userToDelete = null;
    let userToEdit = null;

    // Helper: convert id for query safely
    function idForQuery(id) {
      const n = Number(id);
      return Number.isFinite(n) ? n : id;
    }

    // Init
    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
      try {
        const SUPABASE_URL = 'https://rhcevdopguxtzupuxipk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoY2V2ZG9wZ3V4dHp1cHV4aXBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MjEyNDUsImV4cCI6MjA3MzM5NzI0NX0.Ot6aYOsIRgKjMWrbjPTEXuaWOqXYxYHiXKN1c7AhPyQ';

        if (typeof supabase !== 'undefined') {
          supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          loadUsers();
        } else {
          console.warn('Supabase library not loaded — showing sample data');
          showNotification('ไม่สามารถเชื่อมต่อฐานข้อมูล — แสดงข้อมูลตัวอย่าง', 'info');
          displaySampleData();
        }
      } catch (err) {
        console.error('Init error', err);
        showNotification('เกิดข้อผิดพลาดในการเริ่มต้นระบบ', 'error');
        displaySampleData();
      }
    }

    // Notifications
    function showNotification(message, type = 'info') {
      const n = document.getElementById('notification');
      n.innerHTML = `<i class="fas ${
        type === 'success' ? 'fa-check-circle' : 
        type === 'error' ? 'fa-exclamation-circle' : 
        'fa-info-circle'
      }"></i><div>${escapeHtml(message)}</div>`;
      n.className = `notification ${type} show`;
      setTimeout(() => { n.classList.remove('show'); }, 3000);
    }

    // Modals
    function openModal(){ 
      document.getElementById('deleteModal').style.display = 'flex'; 
    }
    function closeModal(){ 
      document.getElementById('deleteModal').style.display = 'none'; 
      userToDelete = null; 
    }
    function openEditModal(){ 
      document.getElementById('editModal').style.display = 'flex'; 
    }
    function closeEditModal(){ 
      document.getElementById('editModal').style.display = 'none'; 
      userToEdit = null; 
    }

    // Load users
    async function loadUsers() {
      try {
        if (!supabaseClient) throw new Error('Supabase client not initialized');
        const { data, error } = await supabaseClient.from('users').select('*').order('created_at', { ascending: false });
        if (error) throw error;

        // Normalize id to string for UI use
        users = (data || []).map(u => ({ ...u, id: String(u.id), created_at: u.created_at || new Date().toISOString() }));
        renderTable();
        updateStats();
      } catch (err) {
        console.error('loadUsers error', err);
        showNotification('ไม่สามารถโหลดข้อมูลจากฐานข้อมูล', 'error');
        displaySampleData();
      }
    }

    // Render table
    function renderTable() {
      const tbody = document.querySelector('#userTable tbody');
      if (!tbody) return;
      if (!users || users.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align:center;padding:40px;">
              <i class="fas fa-users" style="font-size:48px;color:#f0b6d5;margin-bottom:15px;"></i>
              <div style="font-weight:700;color:var(--gray);">ไม่มีข้อมูลพนักงาน</div>
              <div style="color:var(--gray);font-size:14px;margin-top:5px;">ใช้แบบฟอร์มด้านบนเพื่อเพิ่มพนักงานคนแรก</div>
            </td>
          </tr>`;
        return;
      }

      tbody.innerHTML = '';
      users.forEach((u, idx) => {
        const roleClass = u.role === 'admin' ? 'badge-admin' : 'badge-employee';
        const roleText = u.role === 'admin' ? 'ผู้ดูแลระบบ' : 'พนักงาน';
        let created = '-';
        try { 
          const date = new Date(u.created_at);
          created = date.toLocaleDateString('th-TH', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          }); 
        } catch(e) { 
          created = u.created_at || '-'; 
        }

        tbody.innerHTML += `
          <tr>
            <td>${idx+1}</td>
            <td style="text-align:left;padding-left:12px;font-weight:600;color:var(--dark);">${escapeHtml(u.username)}</td>
            <td><span class="password-cell">${escapeHtml(u.password)}</span></td>
            <td><span class="badge ${roleClass}">${roleText}</span></td>
            <td>${created}</td>
            <td>
              <div style="display:flex;gap:8px;justify-content:center;">
                ${u.role === 'employee' ? 
                  `<button class="edit btn-sm" onclick="prepareEdit('${u.id}')"><i class="fas fa-edit"></i>แก้ไข</button>
                   <button class="delete btn-sm" onclick="prepareDelete('${u.id}','${escapeHtml(u.username)}')"><i class="fas fa-trash"></i>ลบ</button>` :
                  `<span style="color: var(--gray); font-size: 13px;">-</span>`
                }
              </div>
            </td>
          </tr>`;
      });
    }

    // Update stats
    function updateStats() {
      const employeeCount = users.filter(u => u.role === 'employee').length;
      document.getElementById('totalEmployees').textContent = employeeCount;
      
      const today = new Date().toDateString();
      const todayAdded = users.filter(u => {
        const userDate = new Date(u.created_at).toDateString();
        return userDate === today && u.role === 'employee';
      }).length;
      document.getElementById('todayAdded').textContent = todayAdded;
      
      const adminCount = users.filter(u => u.role === 'admin').length;
      document.getElementById('adminCount').textContent = adminCount;
    }

    // Add user
    async function addUser() {
      const usernameEl = document.getElementById('username');
      const passwordEl = document.getElementById('password');
      const addBtn = document.getElementById('addButton');

      const username = (usernameEl.value || '').trim();
      const password = (passwordEl.value || '').trim();
      const role = 'employee';

      if (!username || !password) { 
        showNotification('กรุณากรอกชื่อผู้ใช้และรหัสผ่านให้ครบถ้วน', 'error'); 
        return; 
      }

      const original = addBtn.innerHTML;
      addBtn.innerHTML = '<div class="loading"></div> กำลังเพิ่ม...';
      addBtn.disabled = true;

      try {
        if (!supabaseClient) throw new Error('Supabase client is not initialized');

        // check existing
        const { data: existing, error: checkErr } = await supabaseClient.from('users').select('id').eq('username', username);
        if (checkErr) throw checkErr;
        if (existing && existing.length > 0) { 
          showNotification('มีชื่อผู้ใช้นี้อยู่ในระบบแล้ว', 'error'); 
          return; 
        }

        // insert (reload after)
        const { error } = await supabaseClient.from('users').insert([{ username, password, role }]);
        if (error) throw error;

        usernameEl.value = '';
        passwordEl.value = '';

        await loadUsers();
        showNotification(`เพิ่มพนักงาน "${username}" สำเร็จ`, 'success');
      } catch (err) {
        console.error('addUser error', err);
        showNotification('เกิดข้อผิดพลาดในการเพิ่มพนักงาน', 'error');
      } finally {
        addBtn.innerHTML = original;
        addBtn.disabled = false;
      }
    }

    // Prepare delete
    function prepareDelete(id, username) {
      userToDelete = id;
      document.getElementById('modalMessage').textContent = `คุณแน่ใจหรือไม่ที่จะลบผู้ใช้ "${username}"? การลบนี้จะเป็นการลบถาวรและไม่สามารถกู้คืนได้`;
      openModal();
    }

    // Confirm delete
    async function confirmDelete() {
      if (!userToDelete) return;
      const btn = document.getElementById('confirmDeleteButton');
      const text = document.getElementById('deleteButtonText');
      const original = text.innerHTML;
      text.innerHTML = '<div class="loading"></div> กำลังลบ...';
      btn.disabled = true;

      try {
        if (!supabaseClient) throw new Error('Supabase client not initialized');
        
        const userToDeleteData = users.find(u => u.id === userToDelete);
        if (!userToDeleteData) {
          showNotification('ไม่พบข้อมูลผู้ใช้ที่จะลบ', 'error');
          return;
        }
        
        const name = userToDeleteData.username;
        const qid = idForQuery(userToDelete);
        
        const { error } = await supabaseClient.from('users').delete().eq('id', qid);
        if (error) throw error;
        
        closeModal();
        await loadUsers();
        showNotification(`ลบพนักงาน "${name}" สำเร็จ`, 'success');
      } catch (err) {
        console.error('confirmDelete error', err);
        
        if (err.code === '42501') {
          showNotification('ไม่มีสิทธิ์ในการลบผู้ใช้ กรุณาตรวจสอบการตั้งค่า', 'error');
        } else {
          showNotification('เกิดข้อผิดพลาดในการลบผู้ใช้', 'error');
        }
      } finally {
        text.innerHTML = original;
        btn.disabled = false;
      }
    }

    // Prepare edit
    function prepareEdit(id) {
      userToEdit = users.find(u => String(u.id) === String(id));
      if (!userToEdit) return;
      document.getElementById('editId').value = userToEdit.id;
      document.getElementById('editUsername').value = userToEdit.username;
      document.getElementById('editPassword').value = '';
      openEditModal();
    }

    // Save edit
    async function saveEdit() {
      const id = document.getElementById('editId').value;
      const username = (document.getElementById('editUsername').value || '').trim();
      const password = (document.getElementById('editPassword').value || '').trim();
      const role = 'employee';
      const saveBtn = document.getElementById('saveEditButton');
      const text = document.getElementById('saveButtonText');
      const original = text.innerHTML;

      if (!username) { 
        showNotification('กรุณากรอกชื่อผู้ใช้', 'error'); 
        return; 
      }

      text.innerHTML = '<div class="loading"></div> กำลังบันทึก...'; 
      saveBtn.disabled = true;

      try {
        if (!supabaseClient) throw new Error('Supabase client is not initialized');

        const qid = idForQuery(id);
        const { data: existing, error: checkErr } = await supabaseClient.from('users').select('id').eq('username', username).neq('id', qid);
        if (checkErr) throw checkErr;
        if (existing && existing.length > 0) { 
          showNotification('มีชื่อผู้ใช้นี้อยู่ในระบบแล้ว', 'error'); 
          return; 
        }

        const updateData = { username, role };
        if (password !== '') updateData.password = password;

        const { error } = await supabaseClient.from('users').update(updateData).eq('id', qid);
        if (error) throw error;

        closeEditModal();
        await loadUsers();
        showNotification('อัปเดตข้อมูลผู้ใช้สำเร็จ', 'success');
      } catch (err) {
        console.error('saveEdit error', err);
        showNotification('เกิดข้อผิดพลาดในการอัปเดตข้อมูล', 'error');
      } finally {
        text.innerHTML = original;
        saveBtn.disabled = false;
      }
    }

    // Escape HTML
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str).replace(/[&<>"'`=\/]/g, function (s) {
        return ( { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;' } )[s];
      });
    }

    function displaySampleData() {
      // ตัวอย่างข้อมูลสำหรับแสดงเมื่อไม่มีฐานข้อมูล
      users = [
        {
          id: '1',
          username: 'admin',
          password: 'admin123',
          role: 'admin',
          created_at: new Date().toISOString()
        }
      ];
      renderTable();
      updateStats();
    }
  </script>
</body>
</html>