<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบขายสินค้า - ร้านสุภาวดี</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #d63384;
      --secondary: #9c27b0;
      --light-pink: #fce7f3;
      --light-purple: #f3e8fd;
      --gray: #6c757d;
      --light-gray: #f8f9fa;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
      --white: #FFFFFF;
      --text-dark: #212121;
      --border-color: #e0e0e0;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      transition: all 0.3s ease;
    }
    
    body { 
      background: linear-gradient(135deg, var(--light-pink), var(--light-purple)); 
      color: var(--text-dark); 
      line-height: 1.6; 
      padding: 20px; 
      min-height: 100vh; 
    }
    
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      background: var(--white); 
      padding: 0; 
      border-radius: 15px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
      overflow: hidden;
    }
    
    /* Header */
    .header { 
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .header-icon {
      font-size: 32px;
      background: rgba(255,255,255,0.2);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .header-title {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
    }
    
    .header-subtitle {
      margin: 5px 0 0 0;
      font-size: 16px;
      opacity: 0.9;
    }
    
    .back-btn { 
      display: inline-flex; 
      align-items: center; 
      padding: 10px 20px; 
      background: rgba(255,255,255,0.2); 
      color: white; 
      text-decoration: none; 
      border-radius: 8px; 
      font-weight: 600; 
      transition: all 0.3s ease; 
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .back-btn:hover { 
      background: rgba(255,255,255,0.3); 
      transform: translateY(-2px); 
    }
    
    /* Toolbar */
    .toolbar {
      background: var(--white);
      padding: 15px 30px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .toolbar-left, .toolbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    /* Search Box */
    .search-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .search-input {
      padding: 10px 15px 10px 40px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 250px;
      font-size: 14px;
      background-color: var(--light-gray);
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      color: var(--gray);
    }
    
    /* Buttons */
    button { 
      padding: 10px 18px; 
      cursor: pointer; 
      border: none; 
      border-radius: 8px; 
      font-weight: 600; 
      font-size: 14px; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .btn-primary { 
      background: linear-gradient(to right, var(--primary), var(--secondary)); 
      color: white; 
    }
    
    .btn-success { 
      background: linear-gradient(to right, var(--success), #20c997); 
      color: white; 
    }
    
    .btn-warning { 
      background: linear-gradient(to right, var(--warning), #fd9843); 
      color: white; 
    }
    
    .btn-danger { 
      background: linear-gradient(to right, var(--danger), #e83e8c); 
      color: white; 
    }
    
    .btn-info { 
      background: linear-gradient(to right, var(--info), #6f42c1); 
      color: white; 
    }
    
    .btn-secondary { 
      background: linear-gradient(to right, var(--gray), #495057); 
      color: white; 
    }
    
    .btn-light {
      background: var(--light-gray);
      color: var(--text-dark);
      border: 1px solid var(--border-color);
    }
    
    /* Stats Container */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      padding: 20px 30px;
      background: var(--light-gray);
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      text-align: center;
      border-left: 4px solid var(--primary);
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin: 10px 0;
    }
    
    .stat-label {
      color: var(--gray);
      font-size: 14px;
    }
    
    /* Table Container */
    .table-container {
      padding: 20px 30px;
      overflow-x: auto;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      border-radius: 10px; 
      overflow: hidden; 
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }
    
    table th { 
      background: linear-gradient(to right, var(--primary), var(--secondary)); 
      color: var(--white); 
      padding: 15px; 
      text-align: center; 
      font-weight: 600; 
      font-size: 14px;
    }
    
    table td { 
      padding: 12px 15px; 
      text-align: center; 
      border-bottom: 1px solid var(--border-color); 
      font-size: 14px;
    }
    
    table tr:nth-child(even) { 
      background-color: var(--light-gray); 
    }
    
    table tr:hover { 
      background-color: #f0f5ff; 
      cursor: pointer;
    }
    
    /* Product Image */
    .product-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: transform 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .product-image:hover { 
      transform: scale(1.05); 
    }
    
    /* Quantity Input */
    .quantity-input {
      width: 80px;
      padding: 8px;
      border: 2px solid var(--primary);
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
    }
    
    .quantity-input:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(214, 51, 132, 0.2);
    }
    
    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    
    .action-btn {
      padding: 8px 12px;
      font-size: 12px;
      min-width: 120px;
    }
    
    /* Stock Status */
    .stock-amount { 
      font-weight: 700; 
      color: var(--primary); 
    }
    
    .low-stock { 
      color: var(--warning); 
      font-weight: 700; 
    }
    
    .very-low-stock { 
      color: var(--danger); 
      font-weight: 700; 
    }
    
    /* Status Badges */
    .status-badge { 
      display: inline-block; 
      padding: 5px 12px; 
      border-radius: 20px; 
      font-size: 12px; 
      font-weight: 600; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Floating Cart Container */
    .floating-cart-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 999;
      pointer-events: none;
    }
    
    .floating-cart {
      position: relative;
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.3s ease;
      animation: float 6s ease-in-out infinite;
      pointer-events: all;
      transform: translate3d(0, 0, 0);
      will-change: transform;
    }
    
    .floating-cart:hover {
      transform: scale(1.1) translate3d(0, 0, 0);
      box-shadow: 0 7px 25px rgba(0,0,0,0.3);
      animation-play-state: paused;
    }
    
    .floating-cart i {
      font-size: 28px;
      color: white;
    }
    
    .floating-cart-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--danger);
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Loading */
    #loading { 
      text-align: center; 
      padding: 40px 20px; 
      color: var(--gray); 
      font-size: 18px; 
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    
    .empty-state i {
      font-size: 60px;
      color: #ddd;
      margin-bottom: 20px;
    }
    
    /* Cart Modal */
    .cart-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .cart-modal-content {
      background: white;
      padding: 25px;
      border-radius: 15px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .cart-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .cart-modal-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close-cart-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray);
      padding: 5px;
    }
    
    .cart-items-container {
      margin-bottom: 20px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .cart-item {
      display: flex;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      background-color: var(--light-gray);
      border-radius: 10px;
      border-left: 4px solid var(--primary);
      gap: 15px;
    }
    
    .cart-item-image {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid var(--border-color);
      cursor: pointer;
    }
    
    .cart-item-info {
      flex: 1;
    }
    
    .cart-item-name {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 5px;
    }
    
    .cart-item-price {
      color: var(--gray);
      font-size: 14px;
    }
    
    .cart-item-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .quantity-btn {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    
    .quantity-btn:hover {
      background-color: var(--secondary);
    }
    
    .quantity-btn:disabled {
      background-color: var(--gray);
      cursor: not-allowed;
    }
    
    .quantity-display {
      width: 40px;
      text-align: center;
      font-weight: 600;
    }
    
    .cart-item-total {
      font-weight: 700;
      color: var(--primary);
      min-width: 80px;
      text-align: right;
    }
    
    .remove-item-btn {
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 5px;
      font-size: 16px;
    }
    
    .cart-total-section {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 2px solid var(--border-color);
      text-align: right;
    }
    
    .grand-total {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .cart-actions {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 20px;
    }
    
    /* Image Modal */
    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    
    .image-modal-content {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    }
    
    .image-modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
    }
    
    /* Product Detail Modal */
    .product-detail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      z-index: 2001;
      align-items: center;
      justify-content: center;
    }
    
    .product-detail-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }
    
    .product-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }
    
    .product-detail-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close-product-detail {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray);
      padding: 5px;
    }
    
    .product-detail-body {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .product-detail-image {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      padding: 10px;
      background: var(--light-gray);
    }
    
    .product-detail-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .product-detail-item {
      margin-bottom: 10px;
    }
    
    .product-detail-label {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .product-detail-value {
      font-size: 16px;
      color: var(--text-dark);
    }
    
    .product-detail-description {
      grid-column: 1 / -1;
      background: var(--light-gray);
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    /* Fullscreen Settings Modal */
    .fullscreen-settings-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 2002;
      overflow-y: auto;
    }
    
    .fullscreen-settings-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .fullscreen-settings-title {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .fullscreen-settings-content {
      padding: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .notification-rules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .notification-rule-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      position: relative;
    }
    
    .rule-form-group {
      margin-bottom: 15px;
    }
    
    .rule-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .rule-checkbox input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* Product Selection Modal - ส่วนใหม่ */
    .product-selection-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      z-index: 2003;
      align-items: center;
      justify-content: center;
    }
    
    .product-selection-content {
      background: white;
      padding: 25px;
      border-radius: 15px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }
    
    .product-selection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }
    
    .product-selection-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close-product-selection {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray);
      padding: 5px;
    }
    
    .product-selection-search {
      margin-bottom: 20px;
    }
    
    .selection-search-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
    }
    
    .product-selection-list {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
    }
    
    .selection-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .selection-item:hover {
      background-color: var(--light-gray);
    }
    
    .selection-item:last-child {
      border-bottom: none;
    }
    
    .selection-checkbox {
      margin-right: 15px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .selection-item-info {
      flex: 1;
    }
    
    .selection-item-name {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 5px;
    }
    
    .selection-item-details {
      display: flex;
      gap: 15px;
      color: var(--gray);
      font-size: 13px;
    }
    
    .selection-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }
    
    .selection-count {
      font-size: 14px;
      color: var(--primary);
      font-weight: 600;
    }
    
    /* Rule Product Count Badge */
    .rule-product-count {
      display: inline-block;
      background-color: var(--primary);
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 5px;
      vertical-align: middle;
    }
    
    /* Custom Notification Toggle */
    .custom-notification-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      padding: 10px;
      background-color: var(--light-gray);
      border-radius: 8px;
    }
    
    .toggle-label {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 14px;
    }
    
    /* Custom Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--primary);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    /* Animations */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    /* Responsive */
    @media (max-width: 992px) {
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .toolbar-left, .toolbar-right {
        justify-content: center;
      }
      
      .search-input {
        width: 100%;
      }
      
      .product-detail-info {
        grid-template-columns: 1fr;
      }
      
      .notification-rules-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 0 10px;
      }
      
      .header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
        padding: 15px 20px;
      }
      
      .toolbar {
        padding: 15px 20px;
      }
      
      .stats-container {
        padding: 15px 20px;
        grid-template-columns: repeat(2, 1fr);
      }
      
      .table-container {
        padding: 15px 20px;
      }
      
      th, td {
        padding: 10px 8px;
        font-size: 13px;
      }
      
      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
      
      .action-btn {
        min-width: 100px;
      }
      
      .floating-cart-container {
        bottom: 20px;
        right: 20px;
      }
      
      .floating-cart {
        width: 60px;
        height: 60px;
      }
      
      .cart-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .cart-item-controls {
        width: 100%;
        justify-content: space-between;
      }
      
      .cart-actions {
        flex-direction: column;
      }
    }
    
    @media (max-width: 480px) {
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .header-title {
        font-size: 24px;
      }
      
      .cart-modal-content {
        width: 95%;
        padding: 15px;
      }
      
      .floating-cart-container {
        bottom: 15px;
        right: 15px;
      }
      
      .selection-item-details {
        flex-direction: column;
        gap: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <div class="header-icon">
          <i class="fas fa-cash-register"></i>
        </div>
        <div>
          <h1 class="header-title">ระบบขายสินค้า</h1>
          <p class="header-subtitle">ร้านของใช้และเครื่องสำอางคุณสุภาวดี</p>
        </div>
      </div>
      <a href="employee.html" class="back-btn">
        <i class="fas fa-arrow-left"></i> กลับสู่หน้าหลัก
      </a>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="searchInput" class="search-input" placeholder="ค้นหาสินค้า...">
        </div>
        <button class="btn-light" onclick="clearSearch()">
          <i class="fas fa-times"></i> ล้าง
        </button>
      </div>
      
      <div class="toolbar-right">
        <button class="btn-info" onclick="openCartModal()">
          <i class="fas fa-shopping-cart"></i> ตะกร้าสินค้า
        </button>
        <button class="btn-secondary" onclick="refreshData()">
          <i class="fas fa-sync-alt"></i> รีเฟรช
        </button>
      
      </div>
    </div>

    <!-- Statistics -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-label">สินค้าทั้งหมด</div>
        <div class="stat-value" id="totalProducts">0</div>
        <div class="stat-label">รายการ</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">สินค้าพร้อมขาย</div>
        <div class="stat-value" id="inStockProducts">0</div>
        <div class="stat-label">รายการ</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">สินค้าใกล้หมด</div>
        <div class="stat-value" id="lowStockProducts">0</div>
        <div class="stat-label">รายการ</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ยอดขายวันนี้</div>
        <div class="stat-value" id="todaySales">0.00</div>
        <div class="stat-label">บาท</div>
      </div>
    </div>

    <!-- Table Container -->
    <div class="table-container">
      <table id="productTable">
        <thead>
          <tr>
            <th width="120">รหัสสินค้า</th>
            <th width="80">รูปภาพ</th>
            <th>ชื่อสินค้า</th>
            <th width="120">ราคา</th>
            <th width="120">จำนวนคงเหลือ</th>
            <th width="120">สถานะ</th>
            <th width="150">จำนวนขาย</th>
            <th width="180">จัดการ</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Data will be inserted here -->
        </tbody>
      </table>

      <div id="loading">
        <i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูลสินค้า...
      </div>
    </div>

    <!-- Floating Cart Container -->
    <div class="floating-cart-container" id="floatingCartContainer">
      <div class="floating-cart" onclick="openCartModal()" id="floatingCart">
        <i class="fas fa-shopping-cart"></i>
        <div class="floating-cart-count" id="floatingCartCount">0</div>
      </div>
    </div>

    <!-- Product Detail Modal -->
    <div class="product-detail-modal" id="productDetailModal">
      <div class="product-detail-content">
        <div class="product-detail-header">
          <div class="product-detail-title">
            <i class="fas fa-info-circle"></i> รายละเอียดสินค้า
          </div>
          <button class="close-product-detail" onclick="closeProductDetail()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="product-detail-body" id="productDetailBody">
          <!-- รายละเอียดสินค้าจะแสดงที่นี่ -->
        </div>
        
        <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
          <button class="btn-secondary" onclick="closeProductDetail()">
            <i class="fas fa-times"></i> ปิด
          </button>
          <button class="btn-primary" onclick="addToCartFromDetail()" id="addToCartDetailBtn">
            <i class="fas fa-cart-plus"></i> เพิ่มลงตะกร้า
          </button>
        </div>
      </div>
    </div>

    <!-- Fullscreen Settings Modal -->
    <div class="fullscreen-settings-modal" id="fullscreenSettingsModal">
      <div class="fullscreen-settings-header">
        <div class="fullscreen-settings-title">
          <i class="fas fa-bell"></i> การตั้งค่าการแจ้งเตือนสินค้า
        </div>
        <button class="close-settings-panel" onclick="closeFullscreenSettings()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="fullscreen-settings-content">
        <h3><i class="fas fa-sliders-h"></i> ตั้งค่าสถานะสินค้าตามจำนวนคงเหลือ</h3>
        <p style="color: var(--gray); margin-bottom: 20px;">
          กำหนดเงื่อนไขการแจ้งเตือนสถานะสินค้าตามจำนวนคงเหลือ และเลือกว่าต้องการแจ้งเตือนสำหรับสินค้าใดบ้าง
        </p>
        
        <div style="display:flex; gap:10px; margin-bottom:30px; flex-wrap: wrap;">
          <button class="btn-success" onclick="addNewNotificationRule()">
            <i class="fas fa-plus"></i> เพิ่มกฎใหม่
          </button>
          <button class="btn-secondary" onclick="resetToDefaultRules()">
            <i class="fas fa-undo"></i> คืนค่าเริ่มต้น
          </button>
          <button class="btn-primary" onclick="saveNotificationSettings()">
            <i class="fas fa-save"></i> บันทึกการตั้งค่า
          </button>
        </div>
        
        <div class="notification-rules-grid" id="notificationRulesContainer">
          <!-- กฎการแจ้งเตือนจะแสดงที่นี่ -->
        </div>
        
        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color);">
          <h4><i class="fas fa-info-circle"></i> คำแนะนำการใช้งาน</h4>
          <ul style="color: var(--gray); margin-left: 20px;">
            <li>เลือก "แจ้งเตือน" หากต้องการให้แสดงสถานะนี้ในตารางสินค้า</li>
            <li>เลือก "เลือกสินค้า" เพื่อกำหนดรายการสินค้าที่ต้องการแจ้งเตือนเฉพาะ</li>
            <li>เลือกเงื่อนไขตามต้องการ (มากกว่า, น้อยกว่า, ระหว่าง)</li>
            <li>ตั้งค่าชื่อสถานะและสีให้แตกต่างกันเพื่อให้เห็นชัดเจน</li>
            <li>ระบบจะเลือกสถานะที่ตรงกับเงื่อนไขแรกที่เจอ</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Product Selection Modal - ส่วนใหม่ -->
    <div class="product-selection-modal" id="productSelectionModal">
      <div class="product-selection-content">
        <div class="product-selection-header">
          <div class="product-selection-title">
            <i class="fas fa-boxes"></i> เลือกสินค้าที่ต้องการแจ้งเตือน
          </div>
          <button class="close-product-selection" onclick="closeProductSelectionModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="product-selection-search">
          <input type="text" id="productSelectionSearch" class="selection-search-input" placeholder="ค้นหาสินค้า...">
        </div>
        
        <div class="product-selection-list" id="productSelectionList">
          <!-- รายการสินค้าจะแสดงที่นี่ -->
        </div>
        
        <div class="selection-actions">
          <div class="selection-count">
            เลือกแล้ว: <span id="selectedProductsCount">0</span> รายการ
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn-light" onclick="selectAllProducts()">
              <i class="fas fa-check-square"></i> เลือกทั้งหมด
            </button>
            <button class="btn-light" onclick="deselectAllProducts()">
              <i class="fas fa-times-circle"></i> ยกเลิกทั้งหมด
            </button>
            <button class="btn-success" onclick="saveProductSelection()">
              <i class="fas fa-save"></i> บันทึก
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Cart Modal -->
    <div class="cart-modal" id="cartModal">
      <div class="cart-modal-content">
        <div class="cart-modal-header">
          <div class="cart-modal-title">
            <i class="fas fa-shopping-cart"></i> ตะกร้าสินค้า
          </div>
          <button class="close-cart-modal" onclick="closeCartModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="cart-items-container" id="cartItemsContainer">
          <!-- สินค้าในตะกร้าจะแสดงที่นี่ -->
          <div class="empty-state">
            <i class="fas fa-shopping-cart"></i>
            <p>ยังไม่มีสินค้าในตะกร้า</p>
          </div>
        </div>
        
        <div class="cart-total-section">
          <div class="grand-total">รวมทั้งหมด: <span id="grandTotal">0.00</span> บาท</div>
        </div>
        
        <div class="cart-actions">
          <button class="btn-secondary" onclick="clearCart()">
            <i class="fas fa-trash"></i> ล้างตะกร้า
          </button>
          <button class="btn-success" onclick="completeSale()">
            <i class="fas fa-check"></i> บันทึกรายการขาย
          </button>
        </div>
      </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal">
      <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
      <img class="image-modal-content" id="expandedImage" src="">
    </div>

    <script>
    const SUPABASE_URL = "https://rhcevdopguxtzupuxipk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoY2V2ZG9wZ3V4dHp1cHV4aXBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MjEyNDUsImV4cCI6MjA3MzM5NzI0NX0.Ot6aYOsIRgKjMWrbjPTEXuaWOqXYxYHiXKN1c7AhPyQ";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let products = [];
    let filteredProducts = [];
    let cartItems = [];
    let todaySales = 0;
    let notificationRules = [];
    let nextRuleId = 1;
    let currentProductDetail = null;
    let currentRuleForProductSelection = null;
    let productSelectionCache = {};

    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('tableBody');
    const loading = document.getElementById('loading');
    const floatingCartCount = document.getElementById('floatingCartCount');
    const cartItemsContainer = document.getElementById('cartItemsContainer');
    const grandTotalElement = document.getElementById('grandTotal');
    const totalProductsElement = document.getElementById('totalProducts');
    const inStockProductsElement = document.getElementById('inStockProducts');
    const lowStockProductsElement = document.getElementById('lowStockProducts');
    const todaySalesElement = document.getElementById('todaySales');
    const productDetailModal = document.getElementById('productDetailModal');
    const productDetailBody = document.getElementById('productDetailBody');
    const fullscreenSettingsModal = document.getElementById('fullscreenSettingsModal');
    const notificationRulesContainer = document.getElementById('notificationRulesContainer');
    const productSelectionModal = document.getElementById('productSelectionModal');
    const productSelectionList = document.getElementById('productSelectionList');
    const productSelectionSearch = document.getElementById('productSelectionSearch');
    const selectedProductsCount = document.getElementById('selectedProductsCount');

    // ฟังก์ชันสำหรับดึงรหัสสินค้า
    function getProductCode(product) {
      // ใช้ product_code (varchar) ก่อน ถ้าไม่มีให้ใช้ product_number (integer) และถ้าไม่มีให้ใช้ ID
      if (product.product_code && product.product_code.trim() !== '') {
        return product.product_code;
      } else if (product.product_number) {
        // ถ้า product_number เป็นตัวเลข ให้แสดงเป็น P0001
        return `P${String(product.product_number).padStart(4, '0')}`;
      } else {
        // ถ้าไม่มีทั้งคู่ให้ใช้ ID
        return `ID${String(product.id).padStart(4, '0')}`;
      }
    }

    // Initialize app
    document.addEventListener("DOMContentLoaded", function() {
      initializeApp();
      
      // Add event listeners
      searchInput.addEventListener('input', function() {
        if (this.value.trim() === '') {
          searchProducts();
        }
      });
      
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchProducts();
        }
      });
      
      // Make floating cart draggable
      makeFloatingCartDraggable();
      
      // Load notification rules from localStorage
      loadNotificationRules();
      
      // Initialize table row click events
      setTimeout(initTableRowClicks, 500);
      
      // Add search event for product selection
      productSelectionSearch.addEventListener('input', filterProductSelection);
    });

    // Initialize table row click events
    function initTableRowClicks() {
      const rows = document.querySelectorAll('#tableBody tr');
      rows.forEach(row => {
        row.addEventListener('click', function(e) {
          if (e.target.closest('.action-buttons') || 
              e.target.closest('.product-image') || 
              e.target.closest('input') ||
              e.target.closest('.status-badge')) {
            return;
          }
          
          const productId = this.getAttribute('data-product-id');
          if (productId) {
            openProductDetail(parseInt(productId));
          }
        });
      });
    }

    // Initialize application
    async function initializeApp() {
      try {
        showLoading(true);
        await testConnection();
        await Promise.all([
          loadProducts(),
          loadTodaySales()
        ]);
        showLoading(false);
      } catch (error) {
        console.error("เกิดข้อผิดพลาดในการเริ่มต้นแอปพลิเคชัน:", error);
        showLoadingError("❌ เกิดข้อผิดพลาดในการโหลดข้อมูล");
      }
    }

    // Test connection to Supabase
    async function testConnection() {
      try {
        const { data, error } = await client.from("products").select("count").limit(1);
        
        if (error) {
          console.error("Connection Error:", error);
          showNotification(`❌ ไม่สามารถเชื่อมต่อฐานข้อมูล: ${error.message}`, "danger");
          return false;
        }
        
        console.log("✓ เชื่อมต่อฐานข้อมูลสำเร็จ");
        return true;
      } catch (err) {
        console.error("Test Connection Failed:", err);
        showNotification("❌ เกิดข้อผิดพลาดในการเชื่อมต่อ", "danger");
        return false;
      }
    }

    // Load products from Supabase
    async function loadProducts() {
      try {
        showLoading(true);
        
        const { data, error } = await client.from("products")
          .select("id, product_number, name, price, stock, image_url, description, created_at, product_code")
          .order('created_at', { ascending: true });

        if (error) throw error;
        
        if (!data || data.length === 0) {
          showLoadingError("ไม่พบข้อมูลสินค้าในระบบ");
          return;
        }

        // เพิ่ม field display_code สำหรับการแสดงผล
        products = data.map(product => ({
          ...product,
          display_code: getProductCode(product)
        }));
        
        filteredProducts = [...products];
        
        updateStatistics();
        renderTable();
        
        // Reinitialize table row clicks
        setTimeout(initTableRowClicks, 100);
      } catch (err) {
        console.error("โหลดข้อมูลล้มเหลว:", err);
        showLoadingError("❌ ไม่สามารถโหลดข้อมูลสินค้าได้");
      }
    }

    // Load today's sales
    async function loadTodaySales() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const { data, error } = await client
          .from("sales")
          .select("total_price")
          .eq("sale_date", today);

        if (error) throw error;
        
        if (data) {
          todaySales = data.reduce((sum, sale) => sum + parseFloat(sale.total_price || 0), 0);
        } else {
          todaySales = 0;
        }
        
        todaySalesElement.textContent = todaySales.toFixed(2);
      } catch (err) {
        console.error("โหลดยอดขายล้มเหลว:", err);
        todaySalesElement.textContent = "0.00";
      }
    }

    // Update statistics
    function updateStatistics() {
      const totalProducts = products.length;
      const inStockProducts = products.filter(p => p.stock > 0).length;
      const lowStockProducts = products.filter(p => p.stock > 0 && p.stock <= 10).length;
      
      totalProductsElement.textContent = totalProducts;
      inStockProductsElement.textContent = inStockProducts;
      lowStockProductsElement.textContent = lowStockProducts;
    }

    // Search products
    function searchProducts() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredProducts = [...products];
      } else {
        filteredProducts = products.filter(p =>
          p.name.toLowerCase().includes(searchTerm) ||
          (p.display_code && p.display_code.toLowerCase().includes(searchTerm)) ||
          (p.product_code && p.product_code.toLowerCase().includes(searchTerm)) ||
          (p.product_number && p.product_number.toString().includes(searchTerm))
        );
      }
      
      renderTable();
    }

    // Clear search
    function clearSearch() {
      searchInput.value = "";
      filteredProducts = [...products];
      renderTable();
    }

    // Refresh data
    async function refreshData() {
      showNotification('กำลังรีเฟรชข้อมูล...', 'info');
      showLoading(true);
      try {
        await Promise.all([
          loadProducts(),
          loadTodaySales()
        ]);
        showNotification('รีเฟรชข้อมูลสำเร็จ', 'success');
      } catch (error) {
        showNotification('รีเฟรชข้อมูลไม่สำเร็จ', 'danger');
      } finally {
        showLoading(false);
      }
    }

    // Open product detail modal
    async function openProductDetail(productId) {
      try {
        const { data, error } = await client.from("products")
          .select("*")
          .eq("id", productId)
          .single();

        if (error) throw error;
        
        currentProductDetail = data;
        
        const status = getProductStatus(data);
        const imgSrc = data.image_url || 'https://via.placeholder.com/300x300/e3f2fd/1976d2?text=No+Image';
        const productCode = getProductCode(data);
        
        productDetailBody.innerHTML = `
          <img src="${imgSrc}" class="product-detail-image" alt="${data.name}">
          
          <div class="product-detail-info">
            <div class="product-detail-item">
              <div class="product-detail-label">ชื่อสินค้า</div>
              <div class="product-detail-value">${data.name}</div>
            </div>
            
            <div class="product-detail-item">
              <div class="product-detail-label">รหัสสินค้า</div>
              <div class="product-detail-value">${productCode}</div>
              ${data.product_code ? `<small style="color: var(--gray);">(product_code: ${data.product_code})</small>` : ''}
              ${data.product_number ? `<small style="color: var(--gray);">(product_number: ${data.product_number})</small>` : ''}
            </div>
            
            <div class="product-detail-item">
              <div class="product-detail-label">ราคา</div>
              <div class="product-detail-value">${Number(data.price).toFixed(2)} บาท</div>
            </div>
            
            <div class="product-detail-item">
              <div class="product-detail-label">จำนวนคงเหลือ</div>
              <div class="product-detail-value">
                <span style="font-weight: bold; color: ${status.color}">${data.stock}</span> ชิ้น
              </div>
            </div>
            
            <div class="product-detail-item">
              <div class="product-detail-label">สถานะ</div>
              <div class="product-detail-value">
                <span class="status-badge" style="background-color: ${status.color}; color: ${getContrastColor(status.color)}">
                  ${status.message}
                </span>
              </div>
            </div>
            
            <div class="product-detail-item">
              <div class="product-detail-label">วันที่เพิ่ม</div>
              <div class="product-detail-value">${new Date(data.created_at).toLocaleDateString('th-TH')}</div>
            </div>
          </div>
          
          ${data.description ? `
            <div class="product-detail-description">
              <div class="product-detail-label">รายละเอียด</div>
              <div class="product-detail-value">${data.description}</div>
            </div>
          ` : ''}
          
          <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
            <div class="product-detail-label" style="margin: 0;">จำนวนขาย:</div>
            <input type="number" id="detailQuantity" class="quantity-input" min="1" max="${data.stock}" value="1" style="width: 100px;">
          </div>
        `;
        
        const addBtn = document.getElementById('addToCartDetailBtn');
        if (data.stock === 0) {
          addBtn.disabled = true;
          addBtn.innerHTML = '<i class="fas fa-times-circle"></i> สินค้าหมด';
          addBtn.className = 'btn-danger';
        } else {
          addBtn.disabled = false;
          addBtn.innerHTML = '<i class="fas fa-cart-plus"></i> เพิ่มลงตะกร้า';
          addBtn.className = 'btn-primary';
        }
        
        productDetailModal.style.display = "flex";
        
      } catch (err) {
        console.error("เปิดรายละเอียดสินค้าล้มเหลว:", err);
        showNotification("ไม่สามารถเปิดรายละเอียดสินค้าได้", "danger");
      }
    }

    // Close product detail modal
    function closeProductDetail() {
      productDetailModal.style.display = "none";
      currentProductDetail = null;
    }

    // Add to cart from detail modal
    function addToCartFromDetail() {
      if (!currentProductDetail) return;
      
      const qtyInput = document.getElementById('detailQuantity');
      const qty = parseInt(qtyInput.value);

      if (isNaN(qty) || qty <= 0) {
        showNotification("กรุณาใส่จำนวนที่ถูกต้อง", "warning");
        qtyInput.focus();
        return;
      }

      if (qty > currentProductDetail.stock) {
        showNotification(`ไม่สามารถขายได้ จำนวนสินค้ามีเพียง ${currentProductDetail.stock} ชิ้น`, "warning");
        return;
      }

      const existingItemIndex = cartItems.findIndex(cartItem => cartItem.id === currentProductDetail.id);
      
      if (existingItemIndex !== -1) {
        cartItems[existingItemIndex].quantity += qty;
        cartItems[existingItemIndex].totalPrice = cartItems[existingItemIndex].quantity * cartItems[existingItemIndex].price;
      } else {
        cartItems.push({
          id: currentProductDetail.id,
          name: currentProductDetail.name,
          price: parseFloat(currentProductDetail.price),
          quantity: qty,
          totalPrice: parseFloat(currentProductDetail.price) * qty,
          image_url: currentProductDetail.image_url,
          stock: currentProductDetail.stock
        });
      }

      updateCart();
      showNotification(`เพิ่ม ${currentProductDetail.name} จำนวน ${qty} ชิ้นลงในตะกร้าแล้ว`, "success");
      
      animateFloatingCart();
      closeProductDetail();
    }

    // ========== NOTIFICATION RULES SYSTEM ==========
    
    // Get random color for new rules
    function getRandomColor() {
      const colors = [
        '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2',
        '#EF476F', '#1B9AAA', '#FF9A76', '#7D5BA6', '#90BE6D',
        '#F8961E', '#43AA8B', '#577590', '#F94144', '#F3722C'
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // Save notification rules to localStorage
    function saveRulesToLocalStorage() {
      localStorage.setItem('stockNotificationRules', JSON.stringify(notificationRules));
    }

    // Load notification rules from localStorage
    function loadNotificationRules() {
      const savedRules = localStorage.getItem('stockNotificationRules');
      if (savedRules) {
        notificationRules = JSON.parse(savedRules);
        nextRuleId = notificationRules.length > 0 ? Math.max(...notificationRules.map(r => r.id)) + 1 : 1;
      } else {
        // Default rules
        notificationRules = [
          { 
            id: 1, 
            min: null, 
            max: 10, 
            operator: '<', 
            message: "น้อย", 
            color: "#dc3545", 
            notify: true,
            customProducts: false,
            selectedProductIds: []
          },
          { 
            id: 2, 
            min: 10, 
            max: 80, 
            operator: '>= <=', 
            message: "ปกติ", 
            color: "#28a745", 
            notify: true,
            customProducts: false,
            selectedProductIds: []
          },
          { 
            id: 3, 
            min: 80, 
            max: null, 
            operator: '>', 
            message: "มาก", 
            color: "#ffc107", 
            notify: false,
            customProducts: false,
            selectedProductIds: []
          }
        ];
        nextRuleId = 4;
        saveRulesToLocalStorage();
      }
      
      renderNotificationRules();
    }

    // Validate a rule
    function validateRule(rule) {
      const errors = [];
      
      if (rule.notify) {
        // Check operator conditions
        switch (rule.operator) {
          case '<':
            if (rule.max === null || rule.max === '' || isNaN(parseFloat(rule.max))) {
              errors.push('กรุณาระบุค่าสูงสุดสำหรับเงื่อนไข "น้อยกว่า"');
            }
            break;
          case '>':
            if (rule.min === null || rule.min === '' || isNaN(parseFloat(rule.min))) {
              errors.push('กรุณาระบุค่าต่ำสุดสำหรับเงื่อนไข "มากกว่า"');
            }
            break;
          case '>= <=':
            if (rule.min === null || rule.min === '' || isNaN(parseFloat(rule.min)) || 
                rule.max === null || rule.max === '' || isNaN(parseFloat(rule.max))) {
              errors.push('กรุณาระบุทั้งค่าต่ำสุดและค่าสูงสุดสำหรับเงื่อนไข "ระหว่าง"');
            } else if (parseFloat(rule.min) >= parseFloat(rule.max)) {
              errors.push('ค่าต่ำสุดต้องน้อยกว่าค่าสูงสุด');
            }
            break;
          case '>=':
            if (rule.min === null || rule.min === '' || isNaN(parseFloat(rule.min))) {
              errors.push('กรุณาระบุค่าต่ำสุดสำหรับเงื่อนไข "มากกว่าหรือเท่ากับ"');
            }
            break;
          case '<=':
            if (rule.max === null || rule.max === '' || isNaN(parseFloat(rule.max))) {
              errors.push('กรุณาระบุค่าสูงสุดสำหรับเงื่อนไข "น้อยกว่าหรือเท่ากับ"');
            }
            break;
        }
        
        // Check message
        if (!rule.message || rule.message.trim() === '') {
          errors.push('กรุณาระบุข้อความแจ้งเตือน');
        }
      }
      
      return errors;
    }

    // Check if stock matches rule condition
    function checkRuleMatch(rule, stock) {
      const min = rule.min;
      const max = rule.max;
      
      // Convert stock to number
      const stockNum = parseFloat(stock);
      if (isNaN(stockNum)) return false;
      
      switch (rule.operator) {
        case '<':
          return max !== null && stockNum < parseFloat(max);
        case '>':
          return min !== null && stockNum > parseFloat(min);
        case '>= <=':
          return min !== null && max !== null && 
                 stockNum >= parseFloat(min) && stockNum <= parseFloat(max);
        case '>=':
          return min !== null && stockNum >= parseFloat(min);
        case '<=':
          return max !== null && stockNum <= parseFloat(max);
        default:
          return false;
      }
    }

    // Get product status based on rules
    function getProductStatus(product) {
      if (!notificationRules || notificationRules.length === 0) {
        return {
          message: "ไม่ระบุ",
          color: "#6c757d"
        };
      }
      
      // Filter active rules
      const activeRules = notificationRules.filter(r => r.notify);
      
      if (activeRules.length === 0) {
        return {
          message: "ไม่ระบุ",
          color: "#6c757d"
        };
      }
      
      // Sort rules by specificity (rules with both min and max first)
      const sortedRules = [...activeRules].sort((a, b) => {
        const aSpecific = (a.min !== null && a.max !== null) ? 1 : 0;
        const bSpecific = (b.min !== null && b.max !== null) ? 1 : 0;
        return bSpecific - aSpecific; // More specific rules first
      });
      
      for (const rule of sortedRules) {
        // Check if rule applies to this product
        if (rule.customProducts && rule.selectedProductIds && rule.selectedProductIds.length > 0) {
          if (!rule.selectedProductIds.includes(product.id)) {
            continue;
          }
        }
        
        const matches = checkRuleMatch(rule, product.stock);
        
        if (matches) {
          return {
            message: rule.message,
            color: rule.color
          };
        }
      }
      
      // Default status
      return {
        message: "ไม่ระบุ",
        color: "#6c757d"
      };
    }

    // Add new notification rule
    function addNewNotificationRule() {
      // Find highest max value from existing rules
      const existingMaxValues = notificationRules
        .filter(rule => rule.max !== null)
        .map(rule => parseFloat(rule.max));
      
      const highestMax = existingMaxValues.length > 0 
        ? Math.max(...existingMaxValues) 
        : 0;
      
      const newRule = {
        id: nextRuleId++,
        min: highestMax, // Start from highest max
        max: highestMax + 10, // Add 10 to highest max
        operator: '>= <=',
        message: "กำหนดเอง",
        color: getRandomColor(),
        notify: true,
        customProducts: false,
        selectedProductIds: []
      };
      
      notificationRules.push(newRule);
      saveRulesToLocalStorage();
      renderNotificationRules();
      
      // Scroll to new rule
      setTimeout(() => {
        const rules = notificationRulesContainer.querySelectorAll('.notification-rule-card');
        if (rules.length > 0) {
          rules[rules.length - 1].scrollIntoView({ behavior: 'smooth' });
        }
      }, 100);
    }

    // Update rule functions
    function updateRuleOperator(ruleId, operator) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (rule) {
        rule.operator = operator;
        saveRulesToLocalStorage();
        renderNotificationRules(); // Re-render to update UI
      }
    }
    
    function updateRuleMin(ruleId, min) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (rule) {
        rule.min = min === '' ? null : parseFloat(min);
        saveRulesToLocalStorage();
      }
    }
    
    function updateRuleMax(ruleId, max) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (rule) {
        rule.max = max === '' ? null : parseFloat(max);
        saveRulesToLocalStorage();
      }
    }
    
    function updateRuleMessage(ruleId, message) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (rule) {
        rule.message = message;
        saveRulesToLocalStorage();
      }
    }
    
    function updateRuleColor(ruleId, color) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (rule) {
        rule.color = color;
        saveRulesToLocalStorage();
      }
    }
    
    function toggleNotificationRule(ruleId, notify) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (rule) {
        rule.notify = notify;
        saveRulesToLocalStorage();
        renderNotificationRules(); // Re-render to show/hide errors
      }
    }

    // Change product selection type
    function changeProductSelectionType(ruleId, type) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (!rule) return;
      
      if (type === 'all') {
        rule.customProducts = false;
        rule.selectedProductIds = [];
      } else if (type === 'custom') {
        rule.customProducts = true;
        if (!rule.selectedProductIds) {
          rule.selectedProductIds = [];
        }
      }
      
      saveRulesToLocalStorage();
      renderNotificationRules();
    }

    // Open product selection modal for a specific rule
    function openProductSelectionForRule(ruleId) {
      const rule = notificationRules.find(r => r.id === ruleId);
      if (!rule) return;
      
      currentRuleForProductSelection = ruleId;
      
      productSelectionCache = {
        ruleId: ruleId,
        selectedIds: [...(rule.selectedProductIds || [])]
      };
      
      renderProductSelectionList();
      productSelectionModal.style.display = "flex";
      
      updateSelectedProductsCount();
    }

    // Render product selection list
    function renderProductSelectionList(filter = '') {
      productSelectionList.innerHTML = "";
      
      if (products.length === 0) {
        productSelectionList.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--gray);">
            <i class="fas fa-box-open" style="font-size: 40px; margin-bottom: 15px;"></i>
            <p>ไม่พบข้อมูลสินค้า</p>
          </div>
        `;
        return;
      }
      
      const searchTerm = filter.toLowerCase().trim();
      let filteredProductsList = products;
      
      if (searchTerm) {
        filteredProductsList = products.filter(p =>
          p.name.toLowerCase().includes(searchTerm) ||
          (p.display_code && p.display_code.toLowerCase().includes(searchTerm)) ||
          (p.product_code && p.product_code.toLowerCase().includes(searchTerm)) ||
          (p.product_number && p.product_number.toString().includes(searchTerm))
        );
      }
      
      filteredProductsList.forEach(product => {
        const isSelected = productSelectionCache.selectedIds.includes(product.id);
        const selectionItem = document.createElement('div');
        selectionItem.className = 'selection-item';
        selectionItem.innerHTML = `
          <input type="checkbox" class="selection-checkbox" 
                 id="product-${product.id}" 
                 ${isSelected ? 'checked' : ''}
                 onchange="toggleProductSelection(${product.id}, this.checked)">
          <div class="selection-item-info">
            <div class="selection-item-name">${product.name}</div>
            <div class="selection-item-details">
              <span>รหัส: ${product.display_code}</span>
              <span>ราคา: ${Number(product.price).toFixed(2)} บาท</span>
              <span>คงเหลือ: ${product.stock} ชิ้น</span>
            </div>
          </div>
        `;
        productSelectionList.appendChild(selectionItem);
      });
    }

    // Filter product selection list
    function filterProductSelection() {
      const searchTerm = productSelectionSearch.value;
      renderProductSelectionList(searchTerm);
    }

    // Toggle product selection
    function toggleProductSelection(productId, isSelected) {
      if (isSelected) {
        if (!productSelectionCache.selectedIds.includes(productId)) {
          productSelectionCache.selectedIds.push(productId);
        }
      } else {
        const index = productSelectionCache.selectedIds.indexOf(productId);
        if (index > -1) {
          productSelectionCache.selectedIds.splice(index, 1);
        }
      }
      
      updateSelectedProductsCount();
    }

    // Update selected products count
    function updateSelectedProductsCount() {
      selectedProductsCount.textContent = productSelectionCache.selectedIds.length;
    }

    // Select all products
    function selectAllProducts() {
      const checkboxes = productSelectionList.querySelectorAll('.selection-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = true;
        const productId = parseInt(cb.id.replace('product-', ''));
        if (!productSelectionCache.selectedIds.includes(productId)) {
          productSelectionCache.selectedIds.push(productId);
        }
      });
      
      updateSelectedProductsCount();
    }

    // Deselect all products
    function deselectAllProducts() {
      const checkboxes = productSelectionList.querySelectorAll('.selection-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = false;
      });
      
      productSelectionCache.selectedIds = [];
      updateSelectedProductsCount();
    }

    // Save product selection
    function saveProductSelection() {
      if (!currentRuleForProductSelection) return;
      
      const rule = notificationRules.find(r => r.id === currentRuleForProductSelection);
      if (!rule) return;
      
      rule.selectedProductIds = [...productSelectionCache.selectedIds];
      rule.customProducts = true;
      
      saveRulesToLocalStorage();
      closeProductSelectionModal();
      renderNotificationRules();
      
      showNotification('บันทึกการเลือกสินค้าเรียบร้อยแล้ว', 'success');
    }

    // Close product selection modal
    function closeProductSelectionModal() {
      productSelectionModal.style.display = "none";
      currentRuleForProductSelection = null;
      productSelectionSearch.value = "";
    }

    // Delete notification rule
    function deleteNotificationRule(ruleId) {
      if (!confirm("คุณแน่ใจว่าต้องการลบกฎการแจ้งเตือนนี้?")) return;
      
      notificationRules = notificationRules.filter(r => r.id !== ruleId);
      renderNotificationRules();
      saveRulesToLocalStorage();
    }

    // Reset to default rules
    function resetToDefaultRules() {
      if (!confirm("คุณแน่ใจว่าต้องการคืนค่ากฎการแจ้งเตือนเป็นค่าเริ่มต้น?")) return;
      
      notificationRules = [
        { 
          id: 1, 
          min: null, 
          max: 10, 
          operator: '<', 
          message: "น้อย", 
          color: "#dc3545", 
          notify: true,
          customProducts: false,
          selectedProductIds: []
        },
        { 
          id: 2, 
          min: 10, 
          max: 80, 
          operator: '>= <=', 
          message: "ปกติ", 
          color: "#28a745", 
          notify: true,
          customProducts: false,
          selectedProductIds: []
        },
        { 
          id: 3, 
          min: 80, 
          max: null, 
          operator: '>', 
          message: "มาก", 
          color: "#ffc107", 
          notify: false,
          customProducts: false,
          selectedProductIds: []
        }
      ];
      nextRuleId = 4;
      
      renderNotificationRules();
      saveRulesToLocalStorage();
      showNotification("คืนค่ากฎการแจ้งเตือนเป็นค่าเริ่มต้นเรียบร้อยแล้ว", "success");
    }

    // Render notification rules in fullscreen modal
    function renderNotificationRules() {
      notificationRulesContainer.innerHTML = "";
      
      if (notificationRules.length === 0) {
        notificationRulesContainer.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
            <i class="fas fa-cogs" style="font-size: 60px; color: #ddd; margin-bottom: 20px;"></i>
            <p style="color: #666;">ยังไม่ได้ตั้งค่าการแจ้งเตือน</p>
          </div>
        `;
        return;
      }
      
      // Sort rules by min value
      const sortedRules = [...notificationRules].sort((a, b) => {
        const aMin = a.min === null ? -Infinity : parseFloat(a.min);
        const bMin = b.min === null ? -Infinity : parseFloat(b.min);
        return aMin - bMin;
      });
      
      sortedRules.forEach((rule, index) => {
        // Validate rule
        const errors = validateRule(rule);
        const hasError = errors.length > 0 && rule.notify;
        
        const ruleElement = document.createElement('div');
        ruleElement.className = 'notification-rule-card';
        ruleElement.innerHTML = `
          <div style="position: absolute; top: 10px; right: 10px; font-size: 12px; color: ${rule.color}; font-weight: bold;">
            กฎที่ ${index + 1}
            ${hasError ? '<i class="fas fa-exclamation-circle" style="color: var(--danger); margin-left: 5px;" title="มีข้อผิดพลาด"></i>' : ''}
          </div>
          
          <div class="rule-form-group" style="margin-top: 10px;">
            <div class="custom-notification-toggle" style="${hasError ? 'border: 2px solid var(--danger);' : ''}">
              <div class="toggle-label">
                <i class="fas fa-bell"></i> แจ้งเตือน
                ${rule.customProducts && rule.selectedProductIds && rule.selectedProductIds.length > 0 ? 
                  `<span class="rule-product-count">${rule.selectedProductIds.length}</span>` : ''}
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="notify-${rule.id}" ${rule.notify ? 'checked' : ''} 
                       onchange="toggleNotificationRule(${rule.id}, this.checked)">
                <span class="toggle-slider"></span>
              </label>
            </div>
            ${hasError ? `<div style="color: var(--danger); font-size: 12px; margin-top: 5px;">${errors[0]}</div>` : ''}
          </div>
          
          <div class="rule-form-group">
            <div class="form-label">เลือกรายการสินค้า</div>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
              <div style="flex: 1;">
                <select class="form-input-small" id="productSelectionType-${rule.id}" 
                        onchange="changeProductSelectionType(${rule.id}, this.value)" 
                        style="width: 100%;">
                  <option value="all" ${!rule.customProducts ? 'selected' : ''}>ทุกสินค้า</option>
                  <option value="custom" ${rule.customProducts ? 'selected' : ''}>เลือกสินค้าเฉพาะ</option>
                </select>
              </div>
              ${rule.customProducts ? `
                <button class="btn-info" onclick="openProductSelectionForRule(${rule.id})" 
                        style="padding: 8px 12px; font-size: 12px;">
                  <i class="fas fa-edit"></i> จัดการ
                </button>
              ` : ''}
            </div>
            ${rule.customProducts && rule.selectedProductIds && rule.selectedProductIds.length > 0 ? 
              `<div style="margin-top: 8px; font-size: 12px; color: var(--primary);">
                <i class="fas fa-box"></i> เลือก ${rule.selectedProductIds.length} รายการ
              </div>` : ''}
          </div>
          
          <div class="rule-form-group">
            <div class="form-label">เงื่อนไข</div>
            <select class="form-input-small" id="operator-${rule.id}" 
                    onchange="updateRuleOperator(${rule.id}, this.value)" 
                    style="width: 100%;">
              <option value="<" ${rule.operator === '<' ? 'selected' : ''}>น้อยกว่า</option>
              <option value=">" ${rule.operator === '>' ? 'selected' : ''}>มากกว่า</option>
              <option value=">= <=" ${rule.operator === '>= <=' ? 'selected' : ''}>ระหว่าง</option>
              <option value=">=" ${rule.operator === '>=' ? 'selected' : ''}>มากกว่าหรือเท่ากับ</option>
              <option value="<=" ${rule.operator === '<=' ? 'selected' : ''}>น้อยกว่าหรือเท่ากับ</option>
            </select>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="rule-form-group">
              <div class="form-label">ค่าต่ำสุด</div>
              <input type="number" class="form-input-small" id="min-${rule.id}" 
                     value="${rule.min !== null ? rule.min : ''}" 
                     placeholder="เว้นว่างถ้าไม่มี"
                     onchange="updateRuleMin(${rule.id}, this.value)"
                     step="1"
                     min="0"
                     style="${rule.operator === '>' || rule.operator === '>=' || rule.operator === '>= <=' ? 'border-color: var(--primary);' : ''}">
            </div>
            
            <div class="rule-form-group">
              <div class="form-label">ค่าสูงสุด</div>
              <input type="number" class="form-input-small" id="max-${rule.id}" 
                     value="${rule.max !== null ? rule.max : ''}" 
                     placeholder="เว้นว่างถ้าไม่มี"
                     onchange="updateRuleMax(${rule.id}, this.value)"
                     step="1"
                     min="0"
                     style="${rule.operator === '<' || rule.operator === '<=' || rule.operator === '>= <=' ? 'border-color: var(--primary);' : ''}">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 80px; gap: 10px;">
            <div class="rule-form-group">
              <div class="form-label">ข้อความแจ้งเตือน</div>
              <input type="text" class="form-input-small" id="message-${rule.id}" 
                     value="${rule.message}" 
                     onchange="updateRuleMessage(${rule.id}, this.value)"
                     style="${hasError ? 'border-color: var(--danger);' : ''}">
            </div>
            
            <div class="rule-form-group">
              <div class="form-label">สี</div>
              <input type="color" class="form-input-small" id="color-${rule.id}" 
                     value="${rule.color}" 
                     style="padding: 0; height: 38px;"
                     onchange="updateRuleColor(${rule.id}, this.value)">
            </div>
          </div>
          
          <div style="margin-top: 15px; display: flex; justify-content: flex-end;">
            <button class="btn-danger rule-btn" onclick="deleteNotificationRule(${rule.id})" 
                    style="padding: 6px 12px; font-size: 12px;">
              <i class="fas fa-trash"></i> ลบกฎนี้
            </button>
          </div>
        `;
        notificationRulesContainer.appendChild(ruleElement);
      });
    }

    // Save notification settings from modal
    function saveNotificationSettings() {
      // Validate all rules
      let hasErrors = false;
      let errorMessages = [];
      
      notificationRules.forEach((rule, index) => {
        const errors = validateRule(rule);
        if (errors.length > 0 && rule.notify) {
          hasErrors = true;
          errorMessages.push(`กฎที่ ${index + 1}: ${errors.join(', ')}`);
        }
      });
      
      if (hasErrors) {
        // Show first 3 errors
        const errorMessage = errorMessages.slice(0, 3).join('\n');
        if (errorMessages.length > 3) {
          showNotification(`${errorMessage}\nและอีก ${errorMessages.length - 3} ข้อผิดพลาด...`, "danger");
        } else {
          showNotification(errorMessage, "danger");
        }
        return;
      }
      
      saveRulesToLocalStorage();
      renderTable(); // Update product table
      showNotification("บันทึกการตั้งค่าการแจ้งเตือนเรียบร้อยแล้ว", "success");
    }

    // Open fullscreen settings modal
    function openFullscreenSettings() {
      fullscreenSettingsModal.style.display = "block";
      renderNotificationRules();
    }

    // Close fullscreen settings modal
    function closeFullscreenSettings() {
      fullscreenSettingsModal.style.display = "none";
    }

    // ========== END NOTIFICATION RULES SYSTEM ==========

    // Render product table
    function renderTable() {
      tableBody.innerHTML = "";

      if (filteredProducts.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px 20px;">
              <div class="empty-state">
                <i class="fas fa-search"></i>
                <p>ไม่พบสินค้าที่ตรงกับการค้นหา</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      filteredProducts.forEach((item) => {
        const status = getProductStatus(item);
        const imgSrc = item.image_url || 'https://via.placeholder.com/60x60/e3f2fd/1976d2?text=No+Image';
        const isOutOfStock = item.stock === 0;

        const row = document.createElement('tr');
        row.setAttribute('data-product-id', item.id);
        row.innerHTML = `
          <td><strong>${item.display_code}</strong></td>
          <td>
            <img src="${imgSrc}" 
                 class="product-image" 
                 alt="${item.name}" 
                 onclick="openImageModal('${imgSrc}', '${item.name}')">
          </td>
          <td style="text-align:left;">
            <strong>${item.name}</strong>
          </td>
          <td><strong>${Number(item.price).toFixed(2)}</strong> บาท</td>
          <td class="stock-amount">${item.stock}</td>
          <td>
            <span class="status-badge" 
                  style="background-color: ${status.color}; color: ${getContrastColor(status.color)};"
                  title="คลิกเพื่อดูรายละเอียด"
                  onclick="showStatusDetail(${item.id}, '${item.name}', ${item.stock})">
              ${status.message}
            </span>
          </td>
          <td>
            <input type="number" 
                   class="quantity-input" 
                   id="qty-${item.id}" 
                   min="1" 
                   max="${item.stock}" 
                   value="1"
                   ${isOutOfStock ? 'disabled' : ''}>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-primary action-btn" 
                      onclick="addToCart(${item.id})" 
                      ${isOutOfStock ? 'disabled' : ''}>
                <i class="fas fa-cart-plus"></i> เพิ่มลงตะกร้า
              </button>
            </div>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Show status detail
    function showStatusDetail(productId, productName, stock) {
      const status = getProductStatus({id: productId, stock: stock});
      const matchingRule = notificationRules.find(rule => rule.message === status.message && rule.notify);
      
      let detail = `<strong>${productName}</strong><br>`;
      detail += `จำนวนคงเหลือ: ${stock}<br>`;
      detail += `สถานะ: <span style="color: ${status.color}">${status.message}</span><br>`;
      
      if (matchingRule) {
        detail += `เงื่อนไข: ${formatRuleCondition(matchingRule)}<br>`;
        detail += `สีที่ใช้: <span style="color: ${matchingRule.color}">${matchingRule.color}</span><br>`;
        detail += `แจ้งเตือน: ${matchingRule.notify ? 'เปิด' : 'ปิด'}<br>`;
        
        if (matchingRule.customProducts && matchingRule.selectedProductIds && matchingRule.selectedProductIds.length > 0) {
          detail += `สินค้าที่เลือก: ${matchingRule.selectedProductIds.length} รายการ<br>`;
          
          const selectedProducts = products.filter(p => matchingRule.selectedProductIds.includes(p.id));
          if (selectedProducts.length > 0) {
            detail += `ตัวอย่าง: ${selectedProducts.slice(0, 5).map(p => p.name).join(', ')}`;
            if (selectedProducts.length > 5) detail += ` ...และอีก ${selectedProducts.length - 5} รายการ`;
          }
        } else {
          detail += `สินค้าที่เลือก: ทุกสินค้า`;
        }
      }
      
      alert(detail);
    }

    // Format rule condition for display
    function formatRuleCondition(rule) {
      if (rule.operator === '<' && rule.max !== null) {
        return `น้อยกว่า ${rule.max}`;
      } else if (rule.operator === '>' && rule.min !== null) {
        return `มากกว่า ${rule.min}`;
      } else if (rule.operator === '>= <=' && rule.min !== null && rule.max !== null) {
        return `ตั้งแต่ ${rule.min} ถึง ${rule.max}`;
      } else if (rule.operator === '>=' && rule.min !== null) {
        return `มากกว่าหรือเท่ากับ ${rule.min}`;
      } else if (rule.operator === '<=' && rule.max !== null) {
        return `น้อยกว่าหรือเท่ากับ ${rule.max}`;
      } else {
        return `กำหนดเอง`;
      }
    }

    // Get contrast color for text (black or white)
    function getContrastColor(hexColor) {
      let color = hexColor;
      if (!hexColor.startsWith('#')) {
        const tempDiv = document.createElement('div');
        tempDiv.style.color = hexColor;
        document.body.appendChild(tempDiv);
        color = getComputedStyle(tempDiv).color;
        document.body.removeChild(tempDiv);
      }
      
      let r, g, b;
      if (color.startsWith('rgb')) {
        const rgb = color.match(/\d+/g);
        r = parseInt(rgb[0]);
        g = parseInt(rgb[1]);
        b = parseInt(rgb[2]);
      } else if (color.startsWith('#')) {
        const hex = color.replace('#', '');
        r = parseInt(hex.substr(0, 2), 16);
        g = parseInt(hex.substr(2, 2), 16);
        b = parseInt(hex.substr(4, 2), 16);
      } else {
        return '#000000';
      }
      
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.5 ? '#000000' : '#FFFFFF';
    }

    // Add product to cart
    function addToCart(id) {
      const qtyInput = document.getElementById(`qty-${id}`);
      const qty = parseInt(qtyInput.value);

      if (isNaN(qty) || qty <= 0) {
        showNotification("กรุณาใส่จำนวนที่ถูกต้อง", "warning");
        qtyInput.focus();
        return;
      }

      const item = products.find(p => p.id === id);
      if (!item) {
        showNotification("ไม่พบสินค้านี้ในระบบ", "danger");
        return;
      }

      if (qty > item.stock) {
        showNotification(`ไม่สามารถขายได้ จำนวนสินค้ามีเพียง ${item.stock} ชิ้น`, "warning");
        return;
      }

      const existingItemIndex = cartItems.findIndex(cartItem => cartItem.id === id);
      
      if (existingItemIndex !== -1) {
        cartItems[existingItemIndex].quantity += qty;
        cartItems[existingItemIndex].totalPrice = cartItems[existingItemIndex].quantity * cartItems[existingItemIndex].price;
      } else {
        cartItems.push({
          id: item.id,
          name: item.name,
          price: parseFloat(item.price),
          quantity: qty,
          totalPrice: parseFloat(item.price) * qty,
          image_url: item.image_url,
          stock: item.stock
        });
      }

      updateCart();
      showNotification(`เพิ่ม ${item.name} จำนวน ${qty} ชิ้นลงในตะกร้าแล้ว`, "success");
      
      animateFloatingCart();
    }

    // Update cart display
    function updateCart() {
      const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
      floatingCartCount.textContent = totalItems;
      
      if (cartItems.length === 0) {
        cartItemsContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-shopping-cart"></i>
            <p>ยังไม่มีสินค้าในตะกร้า</p>
          </div>
        `;
        grandTotalElement.textContent = "0.00";
        return;
      }
      
      cartItemsContainer.innerHTML = "";
      let grandTotal = 0;
      
      cartItems.forEach((item, index) => {
        grandTotal += item.totalPrice;
        
        const cartItemDiv = document.createElement('div');
        cartItemDiv.className = 'cart-item';
        cartItemDiv.innerHTML = `
          <img src="${item.image_url || 'https://via.placeholder.com/60x60/e3f2fd/1976d2?text=No+Image'}" 
               alt="${item.name}" 
               class="cart-item-image"
               onclick="openImageModal('${item.image_url || 'https://via.placeholder.com/60x60/e3f2fd/1976d2?text=No+Image'}', '${item.name}')">
          <div class="cart-item-info">
            <div class="cart-item-name">${item.name}</div>
            <div class="cart-item-price">ราคาต่อชิ้น: ${item.price.toFixed(2)} บาท</div>
          </div>
          <div class="cart-item-controls">
            <div class="quantity-controls">
              <button class="quantity-btn" onclick="decreaseCartQuantity(${index})">
                <i class="fas fa-minus"></i>
              </button>
              <div class="quantity-display">${item.quantity}</div>
              <button class="quantity-btn" onclick="increaseCartQuantity(${index})" ${item.quantity >= item.stock ? 'disabled' : ''}>
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div class="cart-item-total">${item.totalPrice.toFixed(2)} บาท</div>
            <button class="remove-item-btn" onclick="removeFromCart(${index})" title="ลบสินค้า">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        cartItemsContainer.appendChild(cartItemDiv);
      });
      
      grandTotalElement.textContent = grandTotal.toFixed(2);
    }

    // Increase quantity in cart
    function increaseCartQuantity(index) {
      const item = cartItems[index];
      
      if (item.quantity >= item.stock) {
        showNotification(`ไม่สามารถเพิ่มจำนวนได้ จำนวนสินค้ามีเพียง ${item.stock} ชิ้น`, "warning");
        return;
      }
      
      item.quantity += 1;
      item.totalPrice = item.quantity * item.price;
      updateCart();
    }

    // Decrease quantity in cart
    function decreaseCartQuantity(index) {
      const item = cartItems[index];
      
      if (item.quantity > 1) {
        item.quantity -= 1;
        item.totalPrice = item.quantity * item.price;
        updateCart();
      } else {
        removeFromCart(index);
      }
    }

    // Remove item from cart
    function removeFromCart(index) {
      if (confirm(`คุณแน่ใจว่าต้องการลบ ${cartItems[index].name} ออกจากตะกร้า?`)) {
        cartItems.splice(index, 1);
        updateCart();
      }
    }

    // Clear cart
    function clearCart() {
      if (cartItems.length === 0) {
        showNotification("ตะกร้าสินค้าว่างอยู่แล้ว", "info");
        return;
      }
      
      if (confirm("คุณแน่ใจว่าต้องการล้างตะกร้าสินค้าทั้งหมด?")) {
        cartItems = [];
        updateCart();
        showNotification("ล้างตะกร้าสินค้าเรียบร้อยแล้ว", "success");
      }
    }

    // Open cart modal
    function openCartModal() {
      document.getElementById("cartModal").style.display = "flex";
    }

    // Close cart modal
    function closeCartModal() {
      document.getElementById("cartModal").style.display = "none";
    }

    // Complete sale
    async function completeSale() {
      if (cartItems.length === 0) {
        showNotification("ไม่มีสินค้าในตะกร้า", "warning");
        return;
      }

      if (!confirm("คุณแน่ใจว่าต้องการบันทึกรายการขายนี้?")) {
        return;
      }

      try {
        for (const item of cartItems) {
          const { data: productData, error: productError } = await client
            .from("products")
            .select("stock")
            .eq("id", item.id)
            .single();

          if (productError) throw productError;

          if (productData.stock < item.quantity) {
            throw new Error(`สินค้า ${item.name} มีจำนวนไม่เพียงพอ (เหลือเพียง ${productData.stock} ชิ้น)`);
          }

          const newStock = productData.stock - item.quantity;

          const { error: updateError } = await client
            .from("products")
            .update({ stock: newStock })
            .eq("id", item.id);

          if (updateError) throw updateError;

          const { error: salesError } = await client
            .from("sales")
            .insert([{
              product_id: item.id,
              qty: item.quantity,
              total_price: item.totalPrice,
              product_name: item.name,
              product_price: item.price,
              sale_date: new Date().toISOString().split('T')[0]
            }]);

          if (salesError) throw salesError;
        }

        cartItems = [];
        updateCart();
        await loadProducts();
        await loadTodaySales();
        
        closeCartModal();
        showNotification("บันทึกรายการขายสำเร็จ", "success");
      } catch (err) {
        console.error("บันทึกรายการขายล้มเหลว:", err);
        showNotification("ไม่สามารถบันทึกรายการขายได้: " + err.message, "danger");
      }
    }

    // Make floating cart draggable
    function makeFloatingCartDraggable() {
      const cartContainer = document.getElementById('floatingCartContainer');
      const cart = document.getElementById('floatingCart');
      let isDragging = false;
      let offsetX, offsetY;
      let startX, startY;
      
      document.addEventListener('selectstart', function(e) {
        if (isDragging) e.preventDefault();
      });
      
      cart.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', stopDrag);
      
      cart.addEventListener('touchstart', startDragTouch);
      document.addEventListener('touchmove', onDragTouch);
      document.addEventListener('touchend', stopDrag);
      
      function startDrag(e) {
        isDragging = true;
        const rect = cartContainer.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        startX = rect.left;
        startY = rect.top;
        
        cart.style.transition = 'none';
        cart.style.cursor = 'grabbing';
        e.preventDefault();
      }
      
      function startDragTouch(e) {
        if (e.touches.length !== 1) return;
        isDragging = true;
        const touch = e.touches[0];
        const rect = cartContainer.getBoundingClientRect();
        offsetX = touch.clientX - rect.left;
        offsetY = touch.clientY - rect.top;
        startX = rect.left;
        startY = rect.top;
        
        cart.style.transition = 'none';
        cart.style.cursor = 'grabbing';
        e.preventDefault();
      }
      
      function onDrag(e) {
        if (!isDragging) return;
        
        const x = e.clientX - offsetX;
        const y = e.clientY - offsetY;
        
        updateCartPosition(x, y);
        e.preventDefault();
      }
      
      function onDragTouch(e) {
        if (!isDragging || e.touches.length !== 1) return;
        
        const touch = e.touches[0];
        const x = touch.clientX - offsetX;
        const y = touch.clientY - offsetY;
        
        updateCartPosition(x, y);
        e.preventDefault();
      }
      
      function updateCartPosition(x, y) {
        const maxX = window.innerWidth - cartContainer.offsetWidth;
        const maxY = window.innerHeight - cartContainer.offsetHeight;
        
        const newX = Math.min(Math.max(0, x), maxX);
        const newY = Math.min(Math.max(0, y), maxY);
        
        cartContainer.style.left = newX + 'px';
        cartContainer.style.top = newY + 'px';
        cartContainer.style.right = 'auto';
        cartContainer.style.bottom = 'auto';
        cartContainer.style.position = 'fixed';
      }
      
      function stopDrag() {
        if (!isDragging) return;
        
        isDragging = false;
        cart.style.transition = 'all 0.3s ease';
        cart.style.cursor = 'pointer';
        
        const rect = cartContainer.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        
        if (rect.left < 50) {
          cartContainer.style.left = '20px';
        }
        else if (rect.left > window.innerWidth - rect.width - 50) {
          cartContainer.style.left = (window.innerWidth - rect.width - 20) + 'px';
        }
        if (rect.top > window.innerHeight - rect.height - 50) {
          cartContainer.style.top = (window.innerHeight - rect.height - 20) + 'px';
        }
      }
    }

    // Animate floating cart
    function animateFloatingCart() {
      const cart = document.getElementById('floatingCart');
      cart.style.animation = 'none';
      setTimeout(() => {
        cart.style.animation = 'float 0.5s ease-in-out';
        setTimeout(() => {
          cart.style.animation = 'float 6s ease-in-out infinite';
        }, 500);
      }, 10);
    }

    // Open image modal
    function openImageModal(src, name) {
      const modal = document.getElementById("imageModal");
      const img = document.getElementById("expandedImage");
      img.src = src;
      img.alt = name;
      modal.style.display = "flex";
    }

    // Close image modal
    function closeImageModal() {
      document.getElementById("imageModal").style.display = "none";
    }

    // Show loading state
    function showLoading(isLoading) {
      loading.style.display = isLoading ? 'block' : 'none';
      if (!isLoading) {
        loading.innerHTML = '';
      }
    }

    // Show loading error
    function showLoadingError(message) {
      loading.innerHTML = `
        <div style="color: var(--danger); padding: 20px; text-align: center;">
          <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
          <h3>${message}</h3>
          <p style="margin-top: 10px; font-size: 14px;">
            กรุณาตรวจสอบ:<br>
            1. การเชื่อมต่ออินเทอร์เน็ต<br>
            2. การตั้งค่า Supabase<br>
            3. ข้อมูลในฐานข้อมูล
          </p>
          <button onclick="refreshData()" class="btn-primary" style="margin-top: 15px;">
            <i class="fas fa-redo"></i> โหลดใหม่
          </button>
        </div>
      `;
    }

    // Show notification
    function showNotification(message, type) {
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(n => n.remove());
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div style="
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 8px;
          background: ${type === 'success' ? '#d4edda' : 
                      type === 'warning' ? '#fff3cd' : 
                      type === 'danger' ? '#f8d7da' : '#d1ecf1'};
          color: ${type === 'success' ? '#155724' : 
                  type === 'warning' ? '#856404' : 
                  type === 'danger' ? '#721c24' : '#0c5460'};
          border: 1px solid ${type === 'success' ? '#c3e6cb' : 
                             type === 'warning' ? '#ffeeba' : 
                             type === 'danger' ? '#f5c6cb' : '#bee5eb'};
          z-index: 9999;
          box-shadow: var(--shadow);
          display: flex;
          align-items: center;
          gap: 10px;
          min-width: 300px;
        ">
          <i class="fas fa-${type === 'success' ? 'check-circle' : 
                            type === 'warning' ? 'exclamation-triangle' : 
                            type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
          <span style="flex: 1;">${message}</span>
          <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 3000);
    }
  </script>
</body>
</html>